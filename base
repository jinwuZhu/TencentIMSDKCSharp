==H
I2lmbmRlZiBDRklMRU1NQVBfSF8KI2RlZmluZSBDRklMRU1NQVBfSF8KCiNpZmRlZiBfV0lOMzIKI2luY2x1ZGUgPFdpbmRvd3MuaD4KI2luY2x1ZGUgPHdjaGFyLmg+CiNlbHNlIAovL19fQVBQTEVfXwovL19saW51eF8KI2luY2x1ZGUgPHN0ZGlvLmg+CiNpbmNsdWRlIDxzeXMvc3RhdC5oPgojaW5jbHVkZSA8c3lzL21tYW4uaD4KI2VuZGlmIC8vIF9XSU4zMl8KI2luY2x1ZGUgPGNzdGRpbnQ+CiNpbmNsdWRlIDxzdHJpbmc+CgpjbGFzcyBDRmlsZU1lbW9yeU1hcAp7CnB1YmxpYzoKCWVudW0gY2xhc3MgQ0ZpbGVNZW1vcnlNYXBNb2RlIHsKCQlDRmlsZU1lbW9yeU1hcE1vZGVfUmVhZCwgLy/lj6ror7sKCQlDRmlsZU1lbW9yeU1hcE1vZGVfUmVhZEFuZFdyaXRlIC8v6K+75YaZCgl9OwpwdWJsaWM6CglDRmlsZU1lbW9yeU1hcCgpOwoJLy/liJvlu7rkuIDkuKrmlofku7bmmKDlsITvvIzmmKDlsITnm67moIfkuLrmjIflrprnmoTmlofku7blkI3np7DvvIzlpoLmnpzmiZPlvIDlpLHotKXvvIzlj6/ku6XnlKhJc09wZW7mo4DpqozmmK/lkKbmiJDlip8KCS8vQHBhcmFtIHN0ckZpbGVOYW1lIFtpbl0g5paH5Lu26Lev5b6ECgkvL0BwYXJhbSBtb2RlIFtpbl0g5pig5bCE5pa55byPIOm7mOiupOWPquivu+aWueW8j+aJk+W8gAoJQ0ZpbGVNZW1vcnlNYXAoY29uc3Qgc3RkOjpzdHJpbmcmIHN0ckZpbGVOYW1lLAoJCUNGaWxlTWVtb3J5TWFwTW9kZSBtb2RlID0gQ0ZpbGVNZW1vcnlNYXBNb2RlOjpDRmlsZU1lbW9yeU1hcE1vZGVfUmVhZCk7CgoJQ0ZpbGVNZW1vcnlNYXAoY29uc3QgQ0ZpbGVNZW1vcnlNYXAmKSA9IGRlbGV0ZTsgLy/kuI3mlK/mjIHlpI3liLbmi7fotJ3mnoTpgKAKCUNGaWxlTWVtb3J5TWFwKENGaWxlTWVtb3J5TWFwJiYgcmlnaHQpOy8vIG5vZXhjZXB0OyBDKysgMTEKCX5DRmlsZU1lbW9yeU1hcCgpOwpwdWJsaWM6CgkvL+aJk+W8gOaWh+S7tu+8jOWwhuaWh+S7tuWGheWuueS7peaYoOWwhOWIsOWGheWtmO+8jAoJLy9AcGFyYW0gc3RyRmlsZU5hbWUgW2luXSDmlofku7bot6/lvoQKCS8vQHBhcmFtIG1vZGUgW2luXSDmmKDlsITmlrnlvI8g6buY6K6k5Y+q6K+75pa55byP5omT5byACgkvL0ByZXR1cm4g5aaC5p6c5oiQ5Yqf77yM6L+U5Zue5pig5bCE55qE5oyH6ZKI77yM5Y+v5Lul6YCa6L+H6L+Z5Liq5oyH6ZKI6K6/6Zeu5paH5Lu25YaF5a65LOi/lOWbnk5VTEzlpLHotKXvvIzor7fmo4DmtYvmmK/lkKblt7Lnu4/miZPlvIDvvIzmiJbmlofku7bkuI3lj6/orr/pl64KCWNoYXIqIE9wZW4oY29uc3Qgc3RkOjpzdHJpbmcmIHN0ckZpbGVOYW1lLCBDRmlsZU1lbW9yeU1hcE1vZGUgbW9kZSA9IENGaWxlTWVtb3J5TWFwTW9kZTo6Q0ZpbGVNZW1vcnlNYXBNb2RlX1JlYWQpOwoKCS8v5YWz6Zet5paH5Lu277yM6Kej5byA5LiO5paH5Lu255qE5pig5bCECgkvL+WFs+mXreWQju+8jOWPr+S7pee7p+e7rU9wZW7miZPlvIDlj6blpJbnmoTmlofku7YKCXZvaWQgQ2xvc2UoKTsKCS8v5qOA6aqM5piv5ZCm5bey57uP5omT5byACgkvL0ByZXR1cm4g5aaC5p6c5bey57uP5omT5byA77yM6L+U5ZuedHJ1ZQoJYm9vbCBJc09wZW4oKSBjb25zdDsKCgkvLwoJLy9AcmV0dXJuIOaVsOaNruaMh+mSiAoJY2hhciogR2V0RGF0YSgpIGNvbnN0OwoJLy8KCS8vQHJldHVybiDmmKDlsITnmoTlpKflsI8KCXVpbnQ2NF90IEdldFNpemUoKSBjb25zdDsKCS8v6I635Y+W5b2T5YmN5omT5byA55qE5paH5Lu25ZCN56ewCgkvL0ByZXR1cm4g5paH5Lu25ZCNCgljb25zdCBzdGQ6OnN0cmluZyYgR2V0RmlsZU5hbWUoKSBjb25zdDsKcHJpdmF0ZToKCXZvaWQgSW5pdChjb25zdCBzdGQ6OnN0cmluZyYgY3N0ckZpbGVOYW1lLCBDRmlsZU1lbW9yeU1hcE1vZGUgbW9kZSk7CnByaXZhdGU6CglDRmlsZU1lbW9yeU1hcE1vZGUgbV9lbk1vZGU7Cglib29sIG1fYk9wZW47CgljaGFyKiBtX3BGaWxlQWRkcjsgLy8KCXVpbnQ2NF90IG1faWxGaWxlQWRkck1hcExlbjsgLy/mmKDlsITnmoTlpKflsI8KCXN0ZDo6c3RyaW5nIG1fc3RyRmlsZU5hbWU7CiNpZmRlZiBfV0lOMzIKCUhBTkRMRSBtX2hGaWxlOwoJSEFORExFIG1faE1hcHBpbmc7CiNlbHNlCglpbnQgbV9mZDsvL+aWh+S7tueahGZkCiNlbmRpZiAvLyBfV0lOMzIKfTsKCiNlbmRpZiAvLyAhQ0ZJTEVNTUFQX0hf
==C
I2luY2x1ZGUgIkNGaWxlTWVtb3J5TWFwLmgiCiNpbmNsdWRlIDxzdHJpbmc+CiNpbmNsdWRlIDx0Y2hhci5oPgojaWZkZWYgVU5JQ09ERQojaW5jbHVkZSA8bG9jYWxlPgojaW5jbHVkZSA8Y29kZWN2dD4KI2VuZGlmIC8vVU5JQ09ERQoKQ0ZpbGVNZW1vcnlNYXA6OkNGaWxlTWVtb3J5TWFwKCkKewoJc3RkOjpzdHJpbmcgc3RyRmlsZU5hbWU7CglJbml0KHN0ckZpbGVOYW1lLCBDRmlsZU1lbW9yeU1hcE1vZGU6OkNGaWxlTWVtb3J5TWFwTW9kZV9SZWFkKTsKfQoKQ0ZpbGVNZW1vcnlNYXA6OkNGaWxlTWVtb3J5TWFwKGNvbnN0IHN0ZDo6c3RyaW5nJiBzdHJGaWxlTmFtZSwgQ0ZpbGVNZW1vcnlNYXBNb2RlIG1vZGUpCnsKCUluaXQoc3RyRmlsZU5hbWUsIG1vZGUpOwp9CgpDRmlsZU1lbW9yeU1hcDo6Q0ZpbGVNZW1vcnlNYXAoQ0ZpbGVNZW1vcnlNYXAmJiByaWdodCkKewoJbV9iT3BlbiA9IHJpZ2h0Lm1fYk9wZW47CglyaWdodC5tX2JPcGVuID0gZmFsc2U7CgltX3BGaWxlQWRkciA9IHJpZ2h0Lm1fcEZpbGVBZGRyOwoJcmlnaHQubV9wRmlsZUFkZHIgPSBOVUxMOwoJbV9pbEZpbGVBZGRyTWFwTGVuID0gcmlnaHQubV9pbEZpbGVBZGRyTWFwTGVuOwoJcmlnaHQubV9pbEZpbGVBZGRyTWFwTGVuID0gMDsKCW1fc3RyRmlsZU5hbWUgPSByaWdodC5tX3N0ckZpbGVOYW1lOwoJcmlnaHQubV9zdHJGaWxlTmFtZS5jbGVhcigpOwojaWZkZWYgX1dJTjMyCgltX2hGaWxlID0gcmlnaHQubV9oRmlsZTsKCXJpZ2h0Lm1faEZpbGUgPSBJTlZBTElEX0hBTkRMRV9WQUxVRTsKCW1faE1hcHBpbmcgPSByaWdodC5tX2hNYXBwaW5nOwoJcmlnaHQubV9oTWFwcGluZyA9IElOVkFMSURfSEFORExFX1ZBTFVFOwojZWxzZQoJbV9mZCA9IHJpZ2h0Lm1fZmQ7CglyaWdodC5tX2ZkID0gMDsKI2VuZGlmIC8vIF9XSU4zMgp9CgpDRmlsZU1lbW9yeU1hcDo6fkNGaWxlTWVtb3J5TWFwKCkgewoJQ2xvc2UoKTsKfQoKY2hhciogQ0ZpbGVNZW1vcnlNYXA6Ok9wZW4oY29uc3Qgc3RkOjpzdHJpbmcmIHN0ckZpbGVOYW1lLCBDRmlsZU1lbW9yeU1hcE1vZGUgbW9kZSkKewoJaWYgKHN0ckZpbGVOYW1lLmVtcHR5KCkpIHsKCQlyZXR1cm4gTlVMTDsKCX0KCWlmIChtX2JPcGVuKSB7CgkJcmV0dXJuIE5VTEw7Cgl9CiNpZmRlZiBfV0lOMzIKCURXT1JEIGR3U2hhcmVNb2RlID0gMDsKCURXT1JEIGZsUHJvdGVjdCA9IDA7CglEV09SRCBkd0Rlc2lyZWRBY2Nlc3MgPSAwOwoJc3dpdGNoIChtb2RlKQoJewoJY2FzZSBDRmlsZU1lbW9yeU1hcDo6Q0ZpbGVNZW1vcnlNYXBNb2RlOjpDRmlsZU1lbW9yeU1hcE1vZGVfUmVhZDoKCXsKCQlkd1NoYXJlTW9kZSA9IEZJTEVfU0hBUkVfUkVBRDsKCQlmbFByb3RlY3QgPSBQQUdFX1JFQURPTkxZOwoJCWR3RGVzaXJlZEFjY2VzcyA9IEZJTEVfTUFQX1JFQUQ7Cgl9YnJlYWs7CgljYXNlIENGaWxlTWVtb3J5TWFwOjpDRmlsZU1lbW9yeU1hcE1vZGU6OkNGaWxlTWVtb3J5TWFwTW9kZV9SZWFkQW5kV3JpdGU6Cgl7CgoJCWR3U2hhcmVNb2RlID0gRklMRV9TSEFSRV9SRUFEIHwgRklMRV9TSEFSRV9XUklURTsKCQlmbFByb3RlY3QgPSBQQUdFX1JFQURXUklURTsKCQlkd0Rlc2lyZWRBY2Nlc3MgPSBGSUxFX01BUF9SRUFEIHwgRklMRV9NQVBfV1JJVEU7Cgl9YnJlYWs7CglkZWZhdWx0OgoJCWJyZWFrOwoJfQojaWZkZWYgVU5JQ09ERQoJc3RkOjp3c3RyaW5nX2NvbnZlcnQ8c3RkOjpjb2RlY3Z0X3V0Zjg8d2NoYXJfdD4sIHdjaGFyX3Q+IGNvbnZlcnRlcjsKCXN0ZDo6d3N0cmluZyB3c3RyRmlsZU5hbWUgPSBjb252ZXJ0ZXIuZnJvbV9ieXRlcyhzdHJGaWxlTmFtZSk7CglzdHJ1Y3QgX3N0YXQ2NCBzdFN0YXQ7CglpZiAoMCAhPSBfdHN0YXQ2NCh3c3RyRmlsZU5hbWUuY19zdHIoKSwgJnN0U3RhdCkpCgl7CgkJcmV0dXJuIE5VTEw7Cgl9CglMQVJHRV9JTlRFR0VSIHN0TEkgPSB7IDAgfTsKCXN0TEkuUXVhZFBhcnQgPSBzdFN0YXQuc3Rfc2l6ZTsKCW1faEZpbGUgPSBDcmVhdGVGaWxlKHdzdHJGaWxlTmFtZS5jX3N0cigpLCBHRU5FUklDX1JFQUQsIGR3U2hhcmVNb2RlLCBOVUxMLCBPUEVOX0VYSVNUSU5HLCBGSUxFX0FUVFJJQlVURV9OT1JNQUwsIE5VTEwpOwoJaWYgKG1faEZpbGUgPT0gSU5WQUxJRF9IQU5ETEVfVkFMVUUpCgl7CgkJcmV0dXJuIE5VTEw7Cgl9CiNlbHNlCglzdHJ1Y3QgX3N0YXQ2NCBzdFN0YXQ7CglpZiAoMCAhPSBfdHN0YXQ2NChzdHJGaWxlTmFtZS5jX3N0cigpLCAmc3RTdGF0KSkKCXsKCQlyZXR1cm4gTlVMTDsKCX0KCUxBUkdFX0lOVEVHRVIgc3RMSSA9IHsgMCB9OwoJc3RMSS5RdWFkUGFydCA9IHN0U3RhdC5zdF9zaXplOwoJbV9oRmlsZSA9IENyZWF0ZUZpbGUoc3RyRmlsZU5hbWUuY19zdHIoKSwgR0VORVJJQ19SRUFELCBkd1NoYXJlTW9kZSwgTlVMTCwgT1BFTl9FWElTVElORywgRklMRV9BVFRSSUJVVEVfTk9STUFMLCBOVUxMKTsKCWlmIChtX2hGaWxlID09IElOVkFMSURfSEFORExFX1ZBTFVFKQoJewoJCXJldHVybiBOVUxMOwoJfQojZW5kaWYgLy8gVU5JQ09ERQoKCW1faE1hcHBpbmcgPSBDcmVhdGVGaWxlTWFwcGluZyhtX2hGaWxlLCBOVUxMLCBmbFByb3RlY3QsIHN0TEkuSGlnaFBhcnQsIHN0TEkuTG93UGFydCwgTlVMTCk7CglpZiAobV9oTWFwcGluZyA9PSBOVUxMKQoJewoJCUNsb3NlSGFuZGxlKG1faEZpbGUpOwoJCW1faEZpbGUgPSBJTlZBTElEX0hBTkRMRV9WQUxVRTsKCQlyZXR1cm4gTlVMTDsKCX0KCW1fcEZpbGVBZGRyID0gKGNoYXIqKU1hcFZpZXdPZkZpbGUobV9oTWFwcGluZywgZHdEZXNpcmVkQWNjZXNzLCAwLCAwLCBzdExJLlF1YWRQYXJ0KTsKCWlmIChudWxscHRyID09IG1fcEZpbGVBZGRyKQoJewoJCUNsb3NlSGFuZGxlKG1faE1hcHBpbmcpOwoJCW1faE1hcHBpbmcgPSBJTlZBTElEX0hBTkRMRV9WQUxVRTsKCQlDbG9zZUhhbmRsZShtX2hGaWxlKTsKCQltX2hGaWxlID0gSU5WQUxJRF9IQU5ETEVfVkFMVUU7CgkJcmV0dXJuIE5VTEw7Cgl9CgltX2lsRmlsZUFkZHJNYXBMZW4gPSBzdFN0YXQuc3Rfc2l6ZTsKCW1fYk9wZW4gPSB0cnVlOwojZWxzZQoJdWludDY0X3QgaWxGaWxlU2l6ZSA9IDA7CglzdHJ1Y3Qgc3RhdCBzdGF0YnVmOwoJaWYgKHN0YXQoc3RyRmlsZU5hbWUuY19zdHIoKSwgJnN0YXRidWYpID09IDApCgl7CgkJaWxGaWxlU2l6ZSA9IHN0YXRidWYuc3Rfc2l6ZTsKCX0KCWVsc2UKCXsKCQlyZXR1cm4gTlVMTDsKCX0KCXN0ZDo6c3RyaW5nIHN0clJlYWRNb2RlOwoJc3dpdGNoIChtb2RlKQoJewoJY2FzZSBDRmlsZU1lbW9yeU1hcDo6Q0ZpbGVNZW1vcnlNYXBNb2RlOjpDRmlsZU1lbW9yeU1hcE1vZGVfUmVhZDoKCXsKCQlzdHJSZWFkTW9kZSA9ICJyYiI7Cgl9YnJlYWs7CgljYXNlIENGaWxlTWVtb3J5TWFwOjpDRmlsZU1lbW9yeU1hcE1vZGU6OkNGaWxlTWVtb3J5TWFwTW9kZV9SZWFkQW5kV3JpdGU6Cgl7CgkJc3RyUmVhZE1vZGUgPSAid2IrIjsKCX1icmVhazsKCWRlZmF1bHQ6Cgl7CgkJcmV0dXJuIE5VTEw7Cgl9YnJlYWs7Cgl9CiNpZmRlZiBVTklDT0RFCgl1c2luZyBjb252ZXJ0VHlwZSA9IHN0ZDo6Y29kZWN2dF91dGY4PHdjaGFyX3Q+CgkJc3RkOjp3c3RyaW5nX2NvbnZlcnQ8Y29udmVydFR5cGUsIHdjaGFyX3Q+IGNvbnZlcnRlcjsKCXN0ZDo6c3RyaW5nIHN0clV0ZjhGaWxlTmFtZSA9IGNvbnZlcnRlci50b19ieXRlcyhzdHJGaWxlTmFtZSk7CgltX2ZkID0gZm9wZW4oc3RyVXRmOEZpbGVOYW1lLmNfc3RyKCksIHN0clJlYWRNb2RlLmNfc3RyKCkpOwojZWxzZQoJbV9mZCA9IGZvcGVuKHN0ckZpbGVOYW1lLmNfc3RyKCksIHN0clJlYWRNb2RlLmNfc3RyKCkpOwojZW5kaWYgLy9VTklDT0RFCglpZiAobV9mZCA8PSAwKQoJewoJCXJldHVybiBOVUxMOwoJfQoJbV9wRmlsZUFkZHIgPSAoY2hhciopbW1hcCgwLCBpbEZpbGVTaXplLCBQUk9UX1JFQUQsIE1BUF9TSEFSRUQsIG1fZmQsIDApOwoJaWYgKG1fcEZpbGVBZGRyID09IE5VTEwpCgl7CgkJbV9iT3BlbiA9IHRydWU7CgkJZmNsb3NlKG1fZmQpOwoJCXJldHVybiBOVUxMOwoJfQoJbV9pbEZpbGVBZGRyTWFwTGVuID0gaWxGaWxlU2l6ZTsKI2VuZGlmIC8vIF9XSU4zMgoKCW1fc3RyRmlsZU5hbWUgPSBzdHJGaWxlTmFtZTsKCW1fZW5Nb2RlID0gbW9kZTsKCglyZXR1cm4gbV9wRmlsZUFkZHI7Cn0Kdm9pZCBDRmlsZU1lbW9yeU1hcDo6Q2xvc2UoKQp7CglpZiAobV9iT3BlbikgewojaWZkZWYgX1dJTjMyCgkJaWYgKG1fcEZpbGVBZGRyKQoJCXsKCQkJVW5tYXBWaWV3T2ZGaWxlKG1fcEZpbGVBZGRyKTsKCQl9CgkJaWYgKG1faE1hcHBpbmcgIT0gSU5WQUxJRF9IQU5ETEVfVkFMVUUpCgkJewoJCQlDbG9zZUhhbmRsZShtX2hNYXBwaW5nKTsKCQkJbV9oTWFwcGluZyA9IElOVkFMSURfSEFORExFX1ZBTFVFOwoJCX0KCQlpZiAobV9oRmlsZSAhPSBJTlZBTElEX0hBTkRMRV9WQUxVRSkKCQl7CgkJCUNsb3NlSGFuZGxlKG1faEZpbGUpOwoJCQltX2hGaWxlID0gSU5WQUxJRF9IQU5ETEVfVkFMVUU7CgkJfQojZWxzZSAKCQlpZiAobV9wRmlsZUFkZHIpCgkJewoJCQltdW5tYXAobV9wRmlsZUFkZHIsIG1faWxGaWxlQWRkck1hcExlbik7CgkJfQoJCWlmIChtX2ZkKQoJCXsKCQkJZmNsb3NlKG1fZmQpOwoJCQltX2ZkID0gMDsKCQl9CiNlbmRpZiAvLyBfV0lOMzJfCgkJbV9wRmlsZUFkZHIgPSBOVUxMOwoJCW1faWxGaWxlQWRkck1hcExlbiA9IDA7CgkJbV9zdHJGaWxlTmFtZS5jbGVhcigpOwoJCW1fYk9wZW4gPSBmYWxzZTsKCX0KfQpib29sIENGaWxlTWVtb3J5TWFwOjpJc09wZW4oKSBjb25zdAp7CglyZXR1cm4gbV9iT3BlbjsKfQpjaGFyKiBDRmlsZU1lbW9yeU1hcDo6R2V0RGF0YSgpIGNvbnN0CnsKCXJldHVybiBtX3BGaWxlQWRkcjsKfQp1aW50NjRfdCBDRmlsZU1lbW9yeU1hcDo6R2V0U2l6ZSgpIGNvbnN0CnsKCXJldHVybiBtX2lsRmlsZUFkZHJNYXBMZW47Cn0KY29uc3Qgc3RkOjpzdHJpbmcmIENGaWxlTWVtb3J5TWFwOjpHZXRGaWxlTmFtZSgpIGNvbnN0CnsKCXJldHVybiBtX3N0ckZpbGVOYW1lOwp9CnZvaWQgQ0ZpbGVNZW1vcnlNYXA6OkluaXQoY29uc3Qgc3RkOjpzdHJpbmcmIHN0ckZpbGVOYW1lLCBDRmlsZU1lbW9yeU1hcE1vZGUgbW9kZSkKewoJbV9pbEZpbGVBZGRyTWFwTGVuID0gMDsKCW1fYk9wZW4gPSBmYWxzZTsKCW1fcEZpbGVBZGRyID0gTlVMTDsKI2lmZGVmIF9XSU4zMgoJbV9oRmlsZSA9IElOVkFMSURfSEFORExFX1ZBTFVFOwoJbV9oTWFwcGluZyA9IElOVkFMSURfSEFORExFX1ZBTFVFOwojZWxzZQoJbV9mZCA9IC0xOy8v5paH5Lu255qEZmQKI2VuZGlmIC8vIF9XSU4zMgoJT3BlbihzdHJGaWxlTmFtZSwgbW9kZSk7Cn0=
==M
I2luY2x1ZGUgPGlvc3RyZWFtPgojaW5jbHVkZSA8c3RyaW5nPgojaW5jbHVkZSA8ZnN0cmVhbT4KI2luY2x1ZGUgPHZlY3Rvcj4KZXh0ZXJuICJDIiB7CiNpbmNsdWRlIDxsaWJhdmZvcm1hdC9hdmZvcm1hdC5oPgojaW5jbHVkZSA8bGliYXZ1dGlsL2F2dXRpbC5oPgojaW5jbHVkZSA8bGliYXZjb2RlYy9hdmNvZGVjLmg+Cn0KI2luY2x1ZGUgIkNGaWxlTWVtb3J5TWFwLmgiCiNpbmNsdWRlICJDb21tLmgiCiNpbmNsdWRlIDxzZXQ+CnZvaWQgQ29weUZpbGVTdHJlYW0oc3RkOjppZnN0cmVhbSYgaW4sIHN0ZDo6b2ZzdHJlYW0mIG91dCwgaW50NjRfdCBsZW4pOwppbnQgRHVtcEZpbGUoY29uc3QgY2hhciogc3RyVmlkZW9GaWxlTmFtZSk7CgppbnQgTWVtb3J5QVZJT1JlYWQodm9pZCogb3BhcXVlLCB1aW50OF90KiBidWYsIGludCBidWZfc2l6ZSk7CgppbnQ2NF90IE1lbW9yeUFWSU9TZWVrKHZvaWQqIG9wYXF1ZSwgaW50NjRfdCBvZmZzZXQsIGludCB3aGVuY2UpOwoKdWludDMyX3QgSXNWaWRlb0ZyYW1lKHVpbnQ4X3QqIHBEYXRhLCBpbnQ2NF90IGlsRGF0YUxlbikgewoJaWYgKGlsRGF0YUxlbiA8IDUpIHsKCQlyZXR1cm4gMDsKCX0KCU5BTCBuYWwgPSBwRGF0YVs0XTsKCXVpbnQ4X3QgbmFsVHlwZSA9IE5BTF9VSU5UVFlQRShuYWwpOwoJaWYgKG5hbFR5cGUgPiAxMyB8fCBuYWxUeXBlIDw9IDAgfHwgbmFsVHlwZSA9PSA3IHx8IG5hbFR5cGUgPT0gOCkKCXsKCQlyZXR1cm4gMDsKCX0KCXVpbnQzMl90IGlGcmFtZVNpemUgPSBTd2FwSW50MzJEYXRhKCooKHVpbnQzMl90KilwRGF0YSkpOwoJaWYgKGlGcmFtZVNpemUgPD0gMCB8fCBpRnJhbWVTaXplID4gMHgwMEZGRkZGRikgewoJCXJldHVybiAwOwoJfQoJcmV0dXJuIGlGcmFtZVNpemU7Cn0KdHlwZWRlZiBzdHJ1Y3QgX1NUUmFuZ2UKewoJaW50NjRfdCBsbFN0YXJ0OwoJaW50NjRfdCBsbEVuZDsKfVNUUmFuZ2U7CmNvbnN0IHVpbnQ4X3QgQUMzX0FTTkNIV09SRCA9IDB4MEI7CmNvbnN0IHVpbnQ4X3QgQUMzX0FTTkNMV09SRCA9IDB4Nzc7CmNvbnN0IHVpbnQ4X3QgQUMzX0FTTkNXT1JEWzJdID0geyBBQzNfQVNOQ0hXT1JELCBBQzNfQVNOQ0xXT1JEIH07CmJvb2wgSXNBdWRpb0ZyYW1lKHVpbnQ4X3QqIHBEYXRhLCBpbnQ2NF90IGlsRGF0YUxlbikgewoJaWYgKGlsRGF0YUxlbiA8IDQpIHsKCQlyZXR1cm4gZmFsc2U7Cgl9CglpZiAocERhdGFbMF0gIT0gQUMzX0FTTkNIV09SRCB8fCBwRGF0YVsxXSAhPSBBQzNfQVNOQ0xXT1JEKSB7CgkJcmV0dXJuIGZhbHNlOwoJfQoJcmV0dXJuIHRydWU7Cn0KCmludCBEdW1wTXA0VmlkZW8oY29uc3QgY2hhciogZmlsZU5hbWUpIHsKCgkvL3N0ZDo6c3RyaW5nIGlucHV0RmlsZU5hbWUgPSAiRDpcXOWOn+inhumikVxcQzAwNTIuTVA0IjsKCXN0ZDo6c3RyaW5nIGlucHV0RmlsZU5hbWUgPSBmaWxlTmFtZTsKCS8v5Yib5bu6SU/lr7nosaEKCXN0ZDo6c3RyaW5nIG91dHB1dEZpbGVOYW1lID0gaW5wdXRGaWxlTmFtZSArICJfZHVtcF92aWQuZGF0YSI7CglzdGQ6Om9mc3RyZWFtIG91dHB1dEZpbGVTdHJlYW0ob3V0cHV0RmlsZU5hbWUuY19zdHIoKSwgc3RkOjppb3M6Om91dCB8IHN0ZDo6aW9zOjpiaW5hcnkpOwoJaWYgKG91dHB1dEZpbGVTdHJlYW0uaXNfb3BlbigpID09IGZhbHNlKSB7CgkJcmV0dXJuIDA7Cgl9CglDRmlsZU1lbW9yeU1hcCBjbEZpbGVNYXAoaW5wdXRGaWxlTmFtZSwgQ0ZpbGVNZW1vcnlNYXA6OkNGaWxlTWVtb3J5TWFwTW9kZTo6Q0ZpbGVNZW1vcnlNYXBNb2RlX1JlYWQpOwoJaWYgKCFjbEZpbGVNYXAuSXNPcGVuKCkpIHsKCQlyZXR1cm4gMDsKCX0KCWludDY0X3QgaWxGaWxlU2l6ZSA9IGNsRmlsZU1hcC5HZXRTaXplKCk7Cgl1aW50OF90KiBwRGF0YSA9ICh1aW50OF90KiljbEZpbGVNYXAuR2V0RGF0YSgpOwoJc3RkOjp2ZWN0b3I8U1RSYW5nZT4gdmVjVmlkZW9SYW5nZXM7CglpbnQ2NF90IGlNYXggPSAwOwoJYm9vbCBiRmluZEZyaXN0QXVkaW8gPSBmYWxzZTsKCWZvciAoaW50NjRfdCBpID0gMDsgaSA8IGlsRmlsZVNpemU7IGkrKykKCXsKCQlpZiAoaU1heCA8IGkpIHsKCQkJaU1heCA9IGk7CgkJfQoKCQl2ZWNWaWRlb1Jhbmdlcy5jbGVhcigpOwoJCS8vRHVtcOWHukgyNjTnmoTop4bpopHluKcKCQlpbnQgaUZyYW1lQ291bnQgPSAwOwoJCXsKCgkJCXVpbnQzMl90IGlGcmFtZVNpemUgPSAwOwoJCQlpbnQ2NF90IGlsVG1wTmV4dE9mZnNldCA9IGk7CgkJCWlGcmFtZVNpemUgPSBJc1ZpZGVvRnJhbWUoJnBEYXRhW2ldLCBpbEZpbGVTaXplIC0gaSk7CgkJCU5BTCBuYWwgPSBwRGF0YVtpICsgNF07CgkJCXVpbnQ4X3QgbmFsVHlwZSA9IE5BTF9VSU5UVFlQRShuYWwpOwoJCQlpRnJhbWVDb3VudCsrOwoJCQl2ZWNWaWRlb1Jhbmdlcy5wdXNoX2JhY2soeyBpICsgNCxpRnJhbWVTaXplICsgaSArIDQgfSk7CgkJCWlmIChpRnJhbWVTaXplID49IDIgJiYgaUZyYW1lU2l6ZSA8PSBpbEZpbGVTaXplIC0gNCAtIGkgJiYKCQkJCShuYWxUeXBlID09IDEgfHwgbmFsVHlwZSA9PSA2IHx8IG5hbFR5cGUgPT0gOSB8fCBuYWxUeXBlID09IDUpKQoJCQl7CgkJCQkvL1RPRE8g5LuO5q2k5aSE5LiA55u05b6A5LiL5pCc57Si77yM55u05Yiw5LiN5piv6KeG6aKR5binCgkJCQlpbFRtcE5leHRPZmZzZXQgPSBpRnJhbWVTaXplICsgaSArIDQ7CgkJCQl3aGlsZSAoaWxGaWxlU2l6ZSA+IGlsVG1wTmV4dE9mZnNldCkKCQkJCXsKCQkJCQlpRnJhbWVTaXplID0gSXNWaWRlb0ZyYW1lKCZwRGF0YVtpbFRtcE5leHRPZmZzZXRdLCBpbEZpbGVTaXplIC0gaWxUbXBOZXh0T2Zmc2V0KTsKCQkJCQlpZiAoaUZyYW1lU2l6ZSA8IDIgfHwgaUZyYW1lU2l6ZSA+IGlsRmlsZVNpemUgLSA0IC0gaWxUbXBOZXh0T2Zmc2V0KSB7CgkJCQkJCWJyZWFrOwoJCQkJCX0KCQkJCQl2ZWNWaWRlb1Jhbmdlcy5wdXNoX2JhY2soeyBpbFRtcE5leHRPZmZzZXQgKyA0LGlGcmFtZVNpemUgKyBpbFRtcE5leHRPZmZzZXQgKyA0IH0pOwoKCQkJCQlpbFRtcE5leHRPZmZzZXQgKz0gKGlGcmFtZVNpemUgKyA0KTsKCgkJCQkJaWYgKGlsVG1wTmV4dE9mZnNldCA9PSAweDU2ZjVlIC0gNCkgewoJCQkJCQlwcmludGYoIkRlYnVnIik7CgkJCQkJfQoJCQkJCWlGcmFtZUNvdW50Kys7CgkJCQl9CgkJCQkvL+iHs+WwkeimgeS4pOS4qui/nue7reeahOW4pwoJCQkJaWYgKGlGcmFtZUNvdW50IDwgMikgewoJCQkJCWNvbnRpbnVlOwoJCQkJfQoJCQkJcHJpbnRmKCJWaWRlbyBGcmFtZSBDb3VudCAlZCBcbiIsIGlGcmFtZUNvdW50KTsKCQkJCWkgPSBpbFRtcE5leHRPZmZzZXQ7CgkJCQkvL1RPRE8g5L+d5a2Y6KeG6aKR5binCgkJCQlmb3IgKGF1dG8gaXRvciA9IHZlY1ZpZGVvUmFuZ2VzLmJlZ2luKCk7IGl0b3IgIT0gdmVjVmlkZW9SYW5nZXMuZW5kKCk7IGl0b3IrKykKCQkJCXsKCQkJCQljb25zdCBTVFJhbmdlJiByYW5nZSA9ICppdG9yOwoJCQkJCWNoYXIgYnVmWzRdID0geyAwLDAsMCwxIH07CgkJCQkJb3V0cHV0RmlsZVN0cmVhbS53cml0ZShidWYsIDQpOwoJCQkJCW91dHB1dEZpbGVTdHJlYW0ud3JpdGUoKGNoYXIqKSgmKHBEYXRhW3JhbmdlLmxsU3RhcnRdKSksIHJhbmdlLmxsRW5kIC0gcmFuZ2UubGxTdGFydCk7CgkJCQl9CgkJCX0KCQl9CgkJaWYgKGlGcmFtZUNvdW50IDwgMikgewoJCQlpRnJhbWVDb3VudCA9IDA7CgkJCWludDY0X3QgaWxUbXBOZXh0T2Zmc2V0ID0gaTsKCgkJCWlmIChpbFRtcE5leHRPZmZzZXQgPT0gMHg1ZWVhNCkgewoJCQkJcHJpbnRmKCJEZWJ1ZyIpOwoJCQl9CgkJCWludCBpQXVkaW9QQkRTaXplID0gMTY3MjsKCQkJaW50IGlBdWRpb01QQkRTaXplID0gMTY3MiAtIDI7CgkJCWJvb2wgYklzQXVkaW9GcmFtZSA9IElzQXVkaW9GcmFtZSgmcERhdGFbaWxUbXBOZXh0T2Zmc2V0XSwgaWxGaWxlU2l6ZSAtIGlsVG1wTmV4dE9mZnNldCk7CgkJCXdoaWxlIChiSXNBdWRpb0ZyYW1lKSB7CgkJCQlpRnJhbWVDb3VudCsrOwoJCQkJYklzQXVkaW9GcmFtZSA9IGZhbHNlOwoJCQkJaWxUbXBOZXh0T2Zmc2V0ICs9IGlBdWRpb01QQkRTaXplOwoJCQkJaWYgKGlsVG1wTmV4dE9mZnNldCA+IGlsRmlsZVNpemUpIHsKCQkJCQlicmVhazsKCQkJCX0KCQkJCWJJc0F1ZGlvRnJhbWUgPSBJc0F1ZGlvRnJhbWUoJnBEYXRhW2lsVG1wTmV4dE9mZnNldF0sIGlsRmlsZVNpemUgLSBpbFRtcE5leHRPZmZzZXQpOwoJCQkJaWYgKGJJc0F1ZGlvRnJhbWUpIHsKCQkJCQljb250aW51ZTsKCQkJCX0KCQkJCWlsVG1wTmV4dE9mZnNldCArPSAyOwoJCQkJaWYgKGlsVG1wTmV4dE9mZnNldCA+IGlsRmlsZVNpemUpIHsKCQkJCQlicmVhazsKCQkJCX0KCQkJCWJJc0F1ZGlvRnJhbWUgPSBJc0F1ZGlvRnJhbWUoJnBEYXRhW2lsVG1wTmV4dE9mZnNldF0sIGlsRmlsZVNpemUgLSBpbFRtcE5leHRPZmZzZXQpOwoJCQl9CgkJCWlmIChpRnJhbWVDb3VudCA+PSAyKSB7CgkJCQlpID0gaWxUbXBOZXh0T2Zmc2V0OwoJCQkJYkZpbmRGcmlzdEF1ZGlvID0gdHJ1ZTsKCQkJCXByaW50ZigiQXVkaW8gRnJhbWUgQ291bnQgJWQgXG4iLCBpRnJhbWVDb3VudCk7CgkJCX0KCQl9CgkJaWYgKGlGcmFtZUNvdW50ID4gMikgewoJCQlpIC0tOwoJCX0KCX0KCglvdXRwdXRGaWxlU3RyZWFtLmNsb3NlKCk7CgkvL1Rlc3QoKTsKCXJldHVybiAwOwp9CgppbnQgbWFpbigpIHsKCS8vRHVtcE1wNFZpZGVvKCJEOlxcTU9W5paH5Lu2XFzljp/op4bpopFcXOWOn+inhumikS3mlrDmlbDmja5cXElNR185OTM3Lk1PViIpOwoJRHVtcE1wNFZpZGVvKCJEOlxc5oiR5Zyo5pe26Ze05bC95aS0562J5L2gLkxvdmUuWW91LkZvcmV2ZXIuMjAyMC40Sy5XRUItREwuSDI2NS5BQUMubWRhdCIpOwoJLy9EdW1wRmlsZSgiRDpcXOWPl+aNn+Wkp+inhumikeeahOWOn+inhumikVxc5oiR5Zyo5pe26Ze05bC95aS0562J5L2gLkxvdmUuWW91LkZvcmV2ZXIuMjAyMC40Sy5XRUItREwuSDI2NS5BQUMubXA0Iik7CglyZXR1cm4gMDsKfQoKI2luY2x1ZGUgPHNzdHJlYW0+IAppbnQgRHVtcEZpbGUoY29uc3QgY2hhciogc3RyVmlkZW9GaWxlTmFtZSkgewoKCS8vc3RkOjpzdHJpbmcgaW5wdXRGaWxlTmFtZSA9ICJEOlxcd29ya1xcQzAwNTItUmVwYWlyMi0yMDkyMDkyOF8xMTAwNTEuaDI2NCI7CglzdGQ6OnNldDx1aW50MzJfdD4gYXVkaW9IZWFkczsKCXN0ZDo6c2V0PHVpbnQ4X3Q+IHZpZGVvVGFnczsKCWludCBhZEZyYW1lQ291bnQgPSAwOwoJc3RkOjpzdHJpbmcgaW5wdXRGaWxlTmFtZSA9IHN0clZpZGVvRmlsZU5hbWU7Ly8gIkQ6XFzljp/op4bpopFcXDUzLm1wNCI7CglzdGQ6OnN0cmluZyBvdXRwdXRGaWxlTmFtZSA9IGlucHV0RmlsZU5hbWUgKyAiX2R1bXAuaDI2NCI7CglzdGQ6Om9mc3RyZWFtIG91dHB1dEZpbGVTdHJlYW0ob3V0cHV0RmlsZU5hbWUsIHN0ZDo6aW9zOjpiaW5hcnkgfCBzdGQ6Omlvczo6b3V0KTsKCWlmIChvdXRwdXRGaWxlU3RyZWFtLmlzX29wZW4oKSA9PSBmYWxzZSkgewoJCWF2X2xvZyhOVUxMLCBBVl9MT0dfV0FSTklORywgIm9wZW4gb3V0cHV0IGZpbGUgZmFpbGVkISFcbiIpOwoJCXJldHVybiAtMTsKCX0KCUFWRm9ybWF0Q29udGV4dCogZm10Q3R4ID0gTlVMTDsKCWludCByZXQgPSBhdmZvcm1hdF9vcGVuX2lucHV0KCZmbXRDdHgsIGlucHV0RmlsZU5hbWUuY19zdHIoKSwgTlVMTCwgTlVMTCk7CglpZiAocmV0ICE9IDApIHsKCQlhdl9sb2coTlVMTCwgQVZfTE9HX1dBUk5JTkcsICJvcGVuIGlucHV0IGZpbGUgZmFpbGVkISFcbiIpOwoJCXJldHVybiAtMTsKCX0KCWF2X2R1bXBfZm9ybWF0KGZtdEN0eCwgMCwgTlVMTCwgMCk7CglpbnQgdmlkZW9TdHJlYW1JZCA9IC0xOwoJZm9yIChzaXplX3QgaSA9IDA7IGkgPCBmbXRDdHgtPm5iX3N0cmVhbXM7IGkrKykKCXsKCQlpZiAoZm10Q3R4LT5zdHJlYW1zW2ldLT5jb2RlY3Bhci0+Y29kZWNfdHlwZSA9PSBBVk1FRElBX1RZUEVfVklERU8pIHsKCQkJdmlkZW9TdHJlYW1JZCA9IGk7CgkJCWJyZWFrOwoJCX0KCX0KCWlmICh2aWRlb1N0cmVhbUlkIDwgMCkgewoJCWF2X2xvZyhOVUxMLCBBVl9MT0dfV0FSTklORywgInZpZGVvIHN0cmVhbSBub3QgZXh0aXMiKTsKCQlhdmZvcm1hdF9jbG9zZV9pbnB1dCgmZm10Q3R4KTsKCQlyZXR1cm4gLTE7Cgl9CgoJLy9vdXRwdXRGaWxlU3RyZWFtLndyaXRlKChjaGFyKikoZm10Q3R4LT5zdHJlYW1zW3ZpZGVvU3RyZWFtSWRdLT5jb2RlY3Bhci0+ZXh0cmFkYXRhKSwgZm10Q3R4LT5zdHJlYW1zW3ZpZGVvU3RyZWFtSWRdLT5jb2RlY3Bhci0+ZXh0cmFkYXRhX3NpemUpOwoJLy9vdXRwdXRGaWxlU3RyZWFtLndyaXRlKCIgICAgIiwgNCk7CglBVlBhY2tldCBwa3Q7CglpbnQ2NF90IGR1bXBTaXplID0gMDsKCgl3aGlsZSAodHJ1ZSkKCXsKCQlhdl9pbml0X3BhY2tldCgmcGt0KTsKCQlyZXQgPSBhdl9yZWFkX2ZyYW1lKGZtdEN0eCwgJnBrdCk7CgkJaWYgKHJldCAhPSAwICkgewoJCQlhdl9wYWNrZXRfdW5yZWYoJnBrdCk7CgkJCWJyZWFrOwoKCQl9CgkJc3RkOjpzdHJpbmcgbXNnOwoJCWlmIChwa3Quc3RyZWFtX2luZGV4ID09IHZpZGVvU3RyZWFtSWQpCgkJewoJCQltc2cgPSBzdGQ6OnN0cmluZygiI1ZEIikgKyBzdGQ6OnRvX3N0cmluZyhwa3Quc2l6ZSkgKyBzdGQ6OnN0cmluZygiVkQjIik7CgkJCWNoYXIgYnVmWzRdID0geyAwLDAsMCwxIH07CgkJCW91dHB1dEZpbGVTdHJlYW0ud3JpdGUoYnVmLCA0KTsKCQkJb3V0cHV0RmlsZVN0cmVhbS53cml0ZSgoY2hhciopKCZwa3QuZGF0YVs0XSksIHBrdC5zaXplIC0gNCk7CgkJfQoJCWVsc2UKCQl7CgkJCWFkRnJhbWVDb3VudCsrOwoJCQltc2cgPSBzdGQ6OnN0cmluZygiI0FEIikgKyBzdGQ6OnRvX3N0cmluZyhwa3Quc2l6ZSkgKyBzdGQ6OnN0cmluZygiQUQjIik7CgkJfQoJCXByaW50ZigiJXNcbiIsIG1zZy5jX3N0cigpKTsKCQkvL291dHB1dEZpbGVTdHJlYW0ud3JpdGUobXNnLmNfc3RyKCksIG1zZy5sZW5ndGgoKSk7Cgl9CglwcmludGYoIltIQ09VTlQvIEZDT1VOVCBdICVkIC8lZCIsIChpbnQpYXVkaW9IZWFkcy5zaXplKCksIGFkRnJhbWVDb3VudCk7CglhdmZvcm1hdF9jbG9zZV9pbnB1dCgmZm10Q3R4KTsKCXJldHVybiAwOwp9CgoKaW50IE1lbW9yeUFWSU9SZWFkKHZvaWQqIG9wYXF1ZSwgdWludDhfdCogYnVmLCBpbnQgYnVmX3NpemUpIHsKCXZvaWQqKiBwYXJhbXMgPSAodm9pZCoqKW9wYXF1ZTsKCS8vQ0ZpbGVNZW1vcnlNYXAqIHBjbEZpbGVNYXAgPSAoQ0ZpbGVNZW1vcnlNYXAqKXBhcmFtc1swXTsKCXVpbnQ4X3QqIHBEYXRhID0gKHVpbnQ4X3QqKShwYXJhbXNbMF0pOwoJaW50NjRfdCYgaWxDdXJyZW50T2Zmc2V0ID0gKigoaW50NjRfdCopcGFyYW1zWzFdKTsKCWludDY0X3QgaWxTdGFydE9mZnNldCA9ICooKGludDY0X3QqKXBhcmFtc1syXSk7CglpbnQ2NF90IGlsRW5kT2Zmc2V0ID0gKigoaW50NjRfdCopcGFyYW1zWzNdKTsKCWludCBpUmVhZFNpemUgPSAoaW50KXN0ZDo6bWluPGludDY0X3Q+KGlsRW5kT2Zmc2V0IC0gaWxDdXJyZW50T2Zmc2V0LCBidWZfc2l6ZSk7CglpZiAoaVJlYWRTaXplIDw9IDApIHsKCQlyZXR1cm4gRU9GOwoJfQoJbWVtY3B5KGJ1ZiwgcERhdGEgKyBpbEN1cnJlbnRPZmZzZXQsIGlSZWFkU2l6ZSk7CglpbEN1cnJlbnRPZmZzZXQgKz0gaVJlYWRTaXplOwoJcmV0dXJuIGlSZWFkU2l6ZTsKfQoKaW50NjRfdCBNZW1vcnlBVklPU2Vlayh2b2lkKiBvcGFxdWUsIGludDY0X3Qgb2Zmc2V0LCBpbnQgd2hlbmNlKSB7Cgl2b2lkKiogcGFyYW1zID0gKHZvaWQqKilvcGFxdWU7CgkvL0NGaWxlTWVtb3J5TWFwKiBwY2xGaWxlTWFwID0gKENGaWxlTWVtb3J5TWFwKilwYXJhbXNbMF07Cgl1aW50OF90KiBwRGF0YSA9ICh1aW50OF90KikocGFyYW1zWzBdKTsKCWludDY0X3QmIGlsQ3VycmVudE9mZnNldCA9ICooKGludDY0X3QqKXBhcmFtc1sxXSk7CglpbnQ2NF90IGlsU3RhcnRPZmZzZXQgPSAqKChpbnQ2NF90KilwYXJhbXNbMl0pOwoJaW50NjRfdCBpbEVuZE9mZnNldCA9ICooKGludDY0X3QqKXBhcmFtc1szXSk7CglpbnQ2NF90IGlsTmV4dE9mZnNldCA9IDA7Cglzd2l0Y2ggKHdoZW5jZSkKCXsKCWNhc2UgU0VFS19TRVQ6Cgl7CgkJaWxOZXh0T2Zmc2V0ID0gb2Zmc2V0ICsgaWxTdGFydE9mZnNldDsKCX1icmVhazsKCWNhc2UgU0VFS19DVVI6Cgl7CgkJaWxOZXh0T2Zmc2V0ID0gaWxDdXJyZW50T2Zmc2V0ICsgb2Zmc2V0OwoJfWJyZWFrOwoJY2FzZSBTRUVLX0VORDoKCXsKCQlpbE5leHRPZmZzZXQgPSBpbEVuZE9mZnNldCArIG9mZnNldDsKCX1icmVhazsKCWNhc2UgQVZTRUVLX1NJWkU6Cgl7CgkJcmV0dXJuIGlsRW5kT2Zmc2V0IC0gaWxTdGFydE9mZnNldDsKCX1icmVhazsKCWRlZmF1bHQ6Cgl7CgkJcmV0dXJuIC0xOwoJfWJyZWFrOwoJfQoJaWYgKGlsTmV4dE9mZnNldCA+IGlsRW5kT2Zmc2V0IHx8IGlsTmV4dE9mZnNldCA8PSBpbFN0YXJ0T2Zmc2V0KSB7CgkJcmV0dXJuIC0xOwoJfQoJaWxDdXJyZW50T2Zmc2V0ID0gaWxOZXh0T2Zmc2V0OwoJcmV0dXJuIDA7Cn0KCnZvaWQgQ29weUZpbGVTdHJlYW0oc3RkOjppZnN0cmVhbSYgaW4sIHN0ZDo6b2ZzdHJlYW0mIG91dCwgaW50NjRfdCBsZW4pIHsKCgljaGFyIGJ1ZlsxMDI0XTsKCWludDY0X3QgY29weVNpemUgPSBsZW47Cgl3aGlsZSAoY29weVNpemUgPiAwKQoJewoJCWludDY0X3QgcmVhZFNpemU7CgkJaWYgKGNvcHlTaXplIDwgc2l6ZW9mKGJ1ZikpIHsKCQkJcmVhZFNpemUgPSBjb3B5U2l6ZTsKCQl9CgkJZWxzZSB7CgkJCXJlYWRTaXplID0gc2l6ZW9mKGJ1Zik7CgkJfQoJCWluLnJlYWQoYnVmLCByZWFkU2l6ZSk7CgkJb3V0LndyaXRlKGJ1ZiwgcmVhZFNpemUpOwoJCWNvcHlTaXplIC09IHJlYWRTaXplOwoJfQp9Cg==
==M2
I2luY2x1ZGUgPGlvc3RyZWFtPgojaW5jbHVkZSA8c3RyaW5nPgojaW5jbHVkZSA8ZnN0cmVhbT4KI2luY2x1ZGUgPHZlY3Rvcj4KZXh0ZXJuICJDIiB7CiNpbmNsdWRlIDxsaWJhdmZvcm1hdC9hdmZvcm1hdC5oPgojaW5jbHVkZSA8bGliYXZ1dGlsL2F2dXRpbC5oPgojaW5jbHVkZSA8bGliYXZjb2RlYy9hdmNvZGVjLmg+Cn0KI2luY2x1ZGUgPHN0Yi9zdGJfaW1hZ2Vfd3JpdGUuaD4KI2luY2x1ZGUgIkNGaWxlTWVtb3J5TWFwLmgiCiNpbmNsdWRlIDxzZXQ+Ci8v6I635Y+WIEgyNjTnvJbnoIFOQUznmoTljZXlhYPnsbvlnovvvIhVSU5UVFlQRe+8ieWNleWFg+exu+Wei+iMg+WbtOS4ujF+MjMg5qCH5YeG5Li6IDF+MTIKI2RlZmluZSBOQUxfVUlOVFRZUEUobmFsKSAoKG5hbCkmKDB4MUYpKQovL+iOt+WPliBIMjY057yW56CBTkFM55qE5LyY5YWI57qn77yIUkVGRVJFTkNFX0JJVO+8iQojZGVmaW5lIE5BTF9SRUZFUkVOQ0UobmFsKSAoKG5hbCkmKDB4NjApKQovL+iOt+WPliBIMjY057yW56CBTkFM55qE56aB5q2i5L2N77yIZm9yYmlkZGVyX2JpdO+8iQojZGVmaW5lIE5BTF9GT1JCSURERVIobmFsKSAoKG5hbCkmKDB4ODApKQp1c2luZyBOQUwgPSB1aW50OF90OwoKdWludDMyX3QgU3dhcEludDMyRGF0YSh1aW50MzJfdCBuVmFsdWVEYXRhKQp7CglyZXR1cm4gKChuVmFsdWVEYXRhICYgMHgwMDAwMDBGRikgPDwgMjQpIHwKCQkoKG5WYWx1ZURhdGEgJiAweDAwMDBGRjAwKSA8PCA4KSB8CgkJKChuVmFsdWVEYXRhICYgMHgwMEZGMDAwMCkgPj4gOCkgfAoJCSgoblZhbHVlRGF0YSAmIDB4RkYwMDAwMDApID4+IDI0KTsKfQoKdm9pZCBDb3B5RmlsZVN0cmVhbShzdGQ6Omlmc3RyZWFtJiBpbiwgc3RkOjpvZnN0cmVhbSYgb3V0LCBpbnQ2NF90IGxlbikgewoKCWNoYXIgYnVmWzEwMjRdOwoJaW50NjRfdCBjb3B5U2l6ZSA9IGxlbjsKCXdoaWxlIChjb3B5U2l6ZSA+IDApCgl7CgkJaW50NjRfdCByZWFkU2l6ZTsKCQlpZiAoY29weVNpemUgPCBzaXplb2YoYnVmKSkgewoJCQlyZWFkU2l6ZSA9IGNvcHlTaXplOwoJCX0KCQllbHNlIHsKCQkJcmVhZFNpemUgPSBzaXplb2YoYnVmKTsKCQl9CgkJaW4ucmVhZChidWYsIHJlYWRTaXplKTsKCQlvdXQud3JpdGUoYnVmLCByZWFkU2l6ZSk7CgkJY29weVNpemUgLT0gcmVhZFNpemU7Cgl9Cn0KCmJvb2wgSXNWaWRlb0ZyYW1lKHVpbnQ4X3QqIHBEYXRhLCBpbnQ2NF90IGlsRGF0YUxlbikgCnsKCU5BTCBuYWwgPSBwRGF0YVs0XTsKCXVpbnQ4X3QgbmFsVXR5cGUgPSBOQUxfVUlOVFRZUEUobmFsKTsKCWlmIChuYWxVdHlwZSA8PSAwIHx8IG5hbFV0eXBlID4gMTIpIHsKCQlyZXR1cm4gZmFsc2U7Cgl9Cgl1aW50MzJfdCBpRnJhbWVTaXplID0gU3dhcEludDMyRGF0YSgqKCh1aW50MzJfdCopKHBEYXRhKSkpOwoJaWYgKGlGcmFtZVNpemUgPCAyIHx8IGlGcmFtZVNpemUgPiAweDAwRkZGRkZGKSB7CgkJcmV0dXJuIGZhbHNlOwoJfQoJcmV0dXJuIHRydWU7Cn0KdHlwZWRlZiBzdHJ1Y3QgX2RtcF92aWRlb19mcmFtZQp7CglpbnQ2NF90IG9mZnNldDsKCXVpbnQzMl90IGxlbmd0aDsKfURWRlJBTUU7CmludCBtYWluKCkgewoJc3RkOjpzdHJpbmcgaW5wdXRGaWxlTmFtZSA9ICJEOlxcdDEubXA0X21kYXQiOwoJc3RkOjpzdHJpbmcgb3V0cHV0RmlsZU5hbWUgPSBpbnB1dEZpbGVOYW1lICsiX2RtcC5kYXRhIjsKCS8v5Yib5bu6SU/lr7nosaEKCXN0ZDo6b2ZzdHJlYW0gb3V0cHV0RmlsZVN0cmVhbShvdXRwdXRGaWxlTmFtZS5jX3N0cigpLHN0ZDo6aW9zOjpiaW5hcnl8c3RkOjppb3M6Om91dCk7CglpZiAob3V0cHV0RmlsZVN0cmVhbS5pc19vcGVuKCkgPT0gZmFsc2UpIHsKCQlyZXR1cm4gLTE7Cgl9CglDRmlsZU1lbW9yeU1hcCBjbEZpbGVNYXAoaW5wdXRGaWxlTmFtZSwgQ0ZpbGVNZW1vcnlNYXA6OkNGaWxlTWVtb3J5TWFwTW9kZTo6Q0ZpbGVNZW1vcnlNYXBNb2RlX1JlYWQpOwoJaWYgKCFjbEZpbGVNYXAuSXNPcGVuKCkpIHsKCQlyZXR1cm4gIC0xOwoJfQoJaW50NjRfdCBpbEZpbGVTaXplID0gY2xGaWxlTWFwLkdldFNpemUoKTsKCXVpbnQ4X3QqIHBEYXRhID0gKHVpbnQ4X3QqKWNsRmlsZU1hcC5HZXREYXRhKCk7CglzdGQ6OnZlY3RvcjxEVkZSQU1FPiB2ZWNWaWRlb0ZyYW1lczsKCWZvciAoaW50NjRfdCBpID0gMDsgaSA8IGlsRmlsZVNpemU7IGkrKykKCXsKCQl2ZWNWaWRlb0ZyYW1lcy5jbGVhcigpOwoJCWlmIChJc1ZpZGVvRnJhbWUoJnBEYXRhW2ldLCBpbEZpbGVTaXplIC0gaSkgPT0gZmFsc2UpIHsKCQkJY29udGludWU7CgkJfQoJCU5BTCBuYWwgPSBwRGF0YVtpICsgNF07CgkJdWludDhfdCBuYWxVdHlwZSA9IE5BTF9VSU5UVFlQRShuYWwpOwoJCWlmIChuYWxVdHlwZSAhPSAxICYmIG5hbFV0eXBlICE9IDYgJiYgbmFsVXR5cGUgIT0gOSkgewoJCQljb250aW51ZTsKCQl9CgkJdWludDMyX3QgaUZyYW1lU2l6ZSA9IFN3YXBJbnQzMkRhdGEoKigodWludDMyX3QqKSgmcERhdGFbaV0pKSk7CgkJaWYgKChpbnQ2NF90KWlGcmFtZVNpemUgPj0gaWxGaWxlU2l6ZSAtIGkgLSA0KSB7CgkJCWNvbnRpbnVlOwoJCX0KCQl2ZWNWaWRlb0ZyYW1lcy5wdXNoX2JhY2soeyBpICsgNCxpRnJhbWVTaXplIH0pOwoJCWludDY0X3QgaWxUbXBOZXh0T2Zmc2V0ID0gaSArIDQgKyBpRnJhbWVTaXplOwoJCXdoaWxlIChpbFRtcE5leHRPZmZzZXQgPCBpbEZpbGVTaXplKQoJCXsKCQkJaWYgKElzVmlkZW9GcmFtZSgmcERhdGFbaWxUbXBOZXh0T2Zmc2V0XSwgaWxGaWxlU2l6ZSAtIGlsVG1wTmV4dE9mZnNldCkgPT0gZmFsc2UpIAoJCQl7CgkJCQlicmVhazsKCQkJfQoJCQlOQUwgbmFsID0gcERhdGFbaWxUbXBOZXh0T2Zmc2V0ICsgNF07CgkJCXVpbnQ4X3QgbmFsVXR5cGUgPSBOQUxfVUlOVFRZUEUobmFsKTsKCQkJaWYgKChuYWxVdHlwZSA9PSA3IHx8IG5hbFV0eXBlID09IDgpICYmIHZlY1ZpZGVvRnJhbWVzLnNpemUoKSA+IDEpIHsKCQkJCWJyZWFrOwoJCQl9CgkJCWlGcmFtZVNpemUgPSBTd2FwSW50MzJEYXRhKCooKHVpbnQzMl90KikoJnBEYXRhW2lsVG1wTmV4dE9mZnNldF0pKSk7CgkJCWlmICgoaW50NjRfdClpRnJhbWVTaXplID4gaWxGaWxlU2l6ZSAtIGlsVG1wTmV4dE9mZnNldCAtIDQpIHsKCQkJCWJyZWFrOwoJCQl9CgkJCXZlY1ZpZGVvRnJhbWVzLnB1c2hfYmFjayh7IGlsVG1wTmV4dE9mZnNldCArIDQsaUZyYW1lU2l6ZSB9KTsKCQkJaWxUbXBOZXh0T2Zmc2V0ICs9ICgoaW50NjRfdClpRnJhbWVTaXplICsgNCk7CgkJfQoJCWlmICh2ZWNWaWRlb0ZyYW1lcy5zaXplKCkgPCAyKSB7CgkJCWNvbnRpbnVlOwoJCX0KCQlpID0gaWxUbXBOZXh0T2Zmc2V0OwoJCXByaW50ZigiRnJhbWVDb3VudCAlZFxuIiwgdmVjVmlkZW9GcmFtZXMuc2l6ZSgpKTsKCQlmb3IgKGF1dG8gaXRvciA9IHZlY1ZpZGVvRnJhbWVzLmJlZ2luKCk7IGl0b3IgIT0gdmVjVmlkZW9GcmFtZXMuZW5kKCk7IGl0b3IrKykKCQl7CgkJCWNoYXIgYnVmWzRdID0geyAwLDAsMCwxIH07CgkJCW91dHB1dEZpbGVTdHJlYW0ud3JpdGUoYnVmLCA0KTsKCQkJY29uc3QgRFZGUkFNRSYgdmlkZW9GcmFtZSA9ICppdG9yOwoJCQlvdXRwdXRGaWxlU3RyZWFtLndyaXRlKChjb25zdCBjaGFyKikoJnBEYXRhW3ZpZGVvRnJhbWUub2Zmc2V0XSksdmlkZW9GcmFtZS5sZW5ndGgpOwoJCX0KCX0KCW91dHB1dEZpbGVTdHJlYW0uY2xvc2UoKTsKCXJldHVybiAwOwp9Cgo=
Mp4Repair::CMp4CorruptExtract
==C
I2luY2x1ZGUgIkNNcDRDb3JydXB0RXh0cmFjdC5oIgoKTXA0UmVwYWlyOjpDTXA0Q29ycnVwdEV4dHJhY3Q6OkNNcDRDb3JydXB0RXh0cmFjdCgpCnsKfQoKTXA0UmVwYWlyOjpDTXA0Q29ycnVwdEV4dHJhY3Q6On5DTXA0Q29ycnVwdEV4dHJhY3QoKQp7Cn0KCnZvaWQgTXA0UmVwYWlyOjpDTXA0Q29ycnVwdEV4dHJhY3Q6OkV4dHJhY3QoQ01wNEV4dHJhY3RGcmFtZXMmIGZyYW1lcywgdWludDhfdCogcERhdGEsIGludDY0X3QgaWxEYXRhTGVuKQp7CglpZiAoZnJhbWVzLmVtcHR5KCkpIHsKCQlyZXR1cm47Cgl9CglzdGQ6OnZlY3RvcjxNcDRSZXBhaXI6OkR1bXBGcmFtZT4gYXJyRG1wRnJhbWVzOwoJZm9yIChpbnQ2NF90IGkgPSAwOyBpIDwgaWxEYXRhTGVuOyBpKyspCgl7CgkJYXJyRG1wRnJhbWVzLmNsZWFyKCk7CgkJZm9yIChhdXRvIHJlZkV4dEZyYW1lcyA9IGZyYW1lcy5iZWdpbigpOyByZWZFeHRGcmFtZXMgIT0gZnJhbWVzLmVuZCgpOyByZWZFeHRGcmFtZXMrKykKCQl7CgkJCXVpbnQzMl90IGlUYWcgPSByZWZFeHRGcmFtZXMtPmZpcnN0OwoJCQlib29sIGJEdW1wU3VjID0gZmFsc2U7CgkJCWludDY0X3QgaWxEdW1wTGVuID0gMDsKCQkJc3dpdGNoIChpVGFnKQoJCQl7CgkJCWNhc2UgTUtUQUcoJ2gnLCcyJywgJzYnLCc0Jyk6CgkJCWNhc2UgTUtUQUcoJ2EnLCd2JywgJ2MnLCdDJyk6CgkJCWNhc2UgTUtUQUcoJ2EnLCd2JywgJ2MnLCcxJyk6CgkJCXsKCQkJCWlsRHVtcExlbiA9IER1bXBIMjY0VmlkZW9GcmFtZSgmcERhdGFbaV0sIGlsRGF0YUxlbiAtIGksIGFyckRtcEZyYW1lcyk7CgkJCQlpZiAoYXJyRG1wRnJhbWVzLnNpemUoKSA+PSAyKSB7CgkJCQkJcHJpbnRmKCJbJWxkXSBWaWRlbyBGcmFtZSAlbGQgXG4iLCBpLCBhcnJEbXBGcmFtZXMuc2l6ZSgpKTsKCQkJCQlmb3IgKGF1dG8gcmVmRG1wRnJhbWUgPSBhcnJEbXBGcmFtZXMuYmVnaW4oKTsgcmVmRG1wRnJhbWUgIT0gYXJyRG1wRnJhbWVzLmVuZCgpOyByZWZEbXBGcmFtZSsrKQoJCQkJCXsKCQkJCQkJcmVmRXh0RnJhbWVzLT5zZWNvbmQucHVzaF9iYWNrKCpyZWZEbXBGcmFtZSk7CgkJCQkJfQoJCQkJfQoJCQl9YnJlYWs7CgkJCWNhc2UgTUtUQUcoJ2EnLCAnYycsICctJywgJzMnKTogCgkJCXsKCQkJCWlsRHVtcExlbiA9IER1bXBBQzNBdWRpb0ZyYW1lKCZwRGF0YVtpXSwgaWxEYXRhTGVuIC0gaSwgYXJyRG1wRnJhbWVzKTsKCQkJCWlmIChhcnJEbXBGcmFtZXMuc2l6ZSgpID49IDIpIHsKCQkJCQlwcmludGYoIlslbGRdIEF1ZGlvIEZyYW1lICVsZCBcbiIsIGksIGFyckRtcEZyYW1lcy5zaXplKCkpOwoJCQkJfQoJCQl9CgkJCWRlZmF1bHQ6CgkJCQlicmVhazsKCQkJfQoJCQlpZiAoYXJyRG1wRnJhbWVzLnNpemUoKSA+PSAyIHx8IGJEdW1wU3VjID09IHRydWUpIAoJCQl7CgkJCQlpICs9IChpbER1bXBMZW4gLSAxKTsKCQkJCWJyZWFrOwoJCQl9CgkJfQoJfQp9CgppbnQ2NF90IE1wNFJlcGFpcjo6Q01wNENvcnJ1cHRFeHRyYWN0OjpEdW1wSDI2NFZpZGVvRnJhbWUodWludDhfdCogcERhdGEsIGludDY0X3QgaWxEYXRhTGVuLCBzdGQ6OnZlY3RvcjxEdW1wRnJhbWU+JiBmcmFtZXMpCnsKCXVpbnQ4X3QqIHBUbXBEYXRhID0gcERhdGE7Cgl1aW50NjRfdCBpbFRtcERhdGFMZW4gPSBpbERhdGFMZW47CglETVBGUkFNRSBzdERtcEZyYW1lOwoJcFRtcERhdGEgPSBtX3N0TXA0SDI2NFBhcnNlci5HZXRGcmFtZUFuZE5leHQoc3REbXBGcmFtZSwgcFRtcERhdGEsIGlsVG1wRGF0YUxlbik7CglpZiAoc3REbXBGcmFtZS5wRnJhbWVEYXRhICE9IE5VTEwgJiYgc3REbXBGcmFtZS5pRnJhbWVTaXplID4gMCkgCgl7CgkJTkFMIG5hbCA9IHN0RG1wRnJhbWUucEZyYW1lRGF0YVswXTsKCQl1aW50OF90IG5hbFVUeXBlID0gTkFMX1VJTlRUWVBFKG5hbCk7CgkJaWYgKG5hbFVUeXBlICE9IDEgJiYgbmFsVVR5cGUgIT0gNSAmJiBuYWxVVHlwZSAhPSA2ICYmIG5hbFVUeXBlICE9IDkpIAoJCXsKCQkJcmV0dXJuIDA7CgkJfQoJfQoJaW50NjRfdCBpbER1bXBMZW4gPSAwOwoJd2hpbGUgKHBUbXBEYXRhICE9IE5VTEwgJiYgc3REbXBGcmFtZS5wRnJhbWVEYXRhICE9IE5VTEwgJiYgc3REbXBGcmFtZS5pRnJhbWVTaXplID4gMCkKCXsKCQlpbER1bXBMZW4gKz0gKHN0RG1wRnJhbWUuaUZyYW1lU2l6ZSArIDQpOwoJCWZyYW1lcy5wdXNoX2JhY2soc3REbXBGcmFtZSk7CgkJcFRtcERhdGEgPSBtX3N0TXA0SDI2NFBhcnNlci5HZXRGcmFtZUFuZE5leHQoc3REbXBGcmFtZSwgcFRtcERhdGEsIGlsVG1wRGF0YUxlbik7Cgl9CiAgICByZXR1cm4gaWxEdW1wTGVuOwp9CgppbnQ2NF90IE1wNFJlcGFpcjo6Q01wNENvcnJ1cHRFeHRyYWN0OjpEdW1wQUMzQXVkaW9GcmFtZSh1aW50OF90KiBwRGF0YSwgaW50NjRfdCBpbERhdGFMZW4sIHN0ZDo6dmVjdG9yPERNUEZSQU1FPiYgZnJhbWVzKQp7Cgl1aW50OF90KiBwVG1wRGF0YSA9IHBEYXRhOwoJdWludDY0X3QgaWxUbXBEYXRhTGVuID0gaWxEYXRhTGVuOwoJRE1QRlJBTUUgc3REbXBGcmFtZTsKCXBUbXBEYXRhID0gbV9zdE1wNEFDM1BhcnNlci5HZXRGcmFtZUFuZE5leHQoc3REbXBGcmFtZSwgcFRtcERhdGEsIGlsVG1wRGF0YUxlbik7CglpbnQ2NF90IGlsRHVtcExlbiA9IDA7Cgl3aGlsZSAocFRtcERhdGEgIT0gTlVMTCAmJiBzdERtcEZyYW1lLnBGcmFtZURhdGEgIT0gTlVMTCAmJiBzdERtcEZyYW1lLmlGcmFtZVNpemUgPiAwKQoJewoJCWZyYW1lcy5wdXNoX2JhY2soc3REbXBGcmFtZSk7CgkJaWxEdW1wTGVuICs9IHN0RG1wRnJhbWUuaUZyYW1lU2l6ZTsKCQlwVG1wRGF0YSA9IG1fc3RNcDRBQzNQYXJzZXIuR2V0RnJhbWVBbmROZXh0KHN0RG1wRnJhbWUsIHBUbXBEYXRhLCBpbFRtcERhdGFMZW4pOwoJfQoJcmV0dXJuIGlsRHVtcExlbjsKfQoKYm9vbCBNcDRSZXBhaXI6OkNNcDRIMjY0UGFyc2VyOjpJc0ZyYW1lKHVpbnQ4X3QqIHBEYXRhLCBpbnQ2NF90IGlsRGF0YUxlbikKewoJaWYgKGlsRGF0YUxlbiA8IDUpIHsKCQlyZXR1cm4gZmFsc2U7Cgl9CglOQUwgbmFsID0gcERhdGFbNF07Cgl1aW50OF90IG5hbFR5cGUgPSBOQUxfVUlOVFRZUEUobmFsKTsKCWlmIChuYWxUeXBlID4gMTMgfHwgbmFsVHlwZSA8PSAwIHx8IG5hbFR5cGUgPT0gNyB8fCBuYWxUeXBlID09IDgpCgl7CgkJcmV0dXJuIDA7Cgl9Cgl1aW50MzJfdCBpRnJhbWVTaXplID0gU3dhcEludDMyRGF0YSgqKCh1aW50MzJfdCopcERhdGEpKTsKCWlmIChpRnJhbWVTaXplIDw9IDAgfHwgaUZyYW1lU2l6ZSA+IDB4MDBGRkZGRkYpIHsKCQlyZXR1cm4gMDsKCX0KCXJldHVybiB0cnVlOwp9Cgp1aW50OF90KiBNcDRSZXBhaXI6OkNNcDRIMjY0UGFyc2VyOjpHZXRGcmFtZUFuZE5leHQoRE1QRlJBTUUmIHN0RnJhbWUsIHVpbnQ4X3QqIHBEYXRhLCBpbnQ2NF90IGlsRGF0YUxlbikKewoJc3RGcmFtZS5wRnJhbWVEYXRhID0gTlVMTDsKCXN0RnJhbWUuaUZyYW1lU2l6ZSA9IDA7CglpZiAoSXNGcmFtZShwRGF0YSwgaWxEYXRhTGVuKSA9PSBmYWxzZSkgewoJCXJldHVybiBwRGF0YTsKCX0KCXVpbnQzMl90IGlGcmFtZVNpemUgPSBTd2FwSW50MzJEYXRhKCooKHVpbnQzMl90KilwRGF0YSkpOwoJaWYgKGlGcmFtZVNpemUgIDwgMiB8fCBpRnJhbWVTaXplID4gMHgwMEZGRkZGRiB8fChpbnQ2NF90KWlGcmFtZVNpemUgPiAoaWxEYXRhTGVuIC0gNCkpIHsKCQlyZXR1cm4gcERhdGE7Cgl9CgllbHNlIHsKCQlzdEZyYW1lLnBGcmFtZURhdGEgPSBwRGF0YSArIDQ7CgkJc3RGcmFtZS5pRnJhbWVTaXplID0gaUZyYW1lU2l6ZTsKCQlyZXR1cm4gKHBEYXRhICsgNCArIGlGcmFtZVNpemUpOwoJfQoJcmV0dXJuIHBEYXRhOwp9CgpNcDRSZXBhaXI6OkNNcDRBQzNQYXJzZXI6OkNNcDRBQzNQYXJzZXIoKQp7CgltX2lCdWZmZXJTaXplREIgPSAxNjcyOwp9Cgp2b2lkIE1wNFJlcGFpcjo6Q01wNEFDM1BhcnNlcjo6U2V0QnVmZmVyU2l6ZURCKGludCBpU2l6ZSkKewoJbV9pQnVmZmVyU2l6ZURCID0gaVNpemU7Cn0KCmJvb2wgTXA0UmVwYWlyOjpDTXA0QUMzUGFyc2VyOjpJc0ZyYW1lKHVpbnQ4X3QqIHBEYXRhLCBpbnQ2NF90IGlsRGF0YUxlbikKewoJaWYgKGlsRGF0YUxlbiA8IDEyNikgewoJCXJldHVybiBmYWxzZTsKCX0KCWlmIChwRGF0YVswXSAhPSBBQzNfQVNOQ0hXT1JEIHx8IHBEYXRhWzFdICE9IEFDM19BU05DTFdPUkQpIHsKCQlyZXR1cm4gZmFsc2U7Cgl9CglyZXR1cm4gdHJ1ZTsKfQoKdWludDhfdCogTXA0UmVwYWlyOjpDTXA0QUMzUGFyc2VyOjpHZXRGcmFtZUFuZE5leHQoRE1QRlJBTUUmIHN0RnJhbWUsIHVpbnQ4X3QqIHBEYXRhLCBpbnQ2NF90IGlsRGF0YUxlbikKewoJc3RGcmFtZS5wRnJhbWVEYXRhID0gTlVMTDsKCXN0RnJhbWUuaUZyYW1lU2l6ZSA9IDA7CglpZiAobV9pQnVmZmVyU2l6ZURCIDwgMTI2KSB7CgkJcmV0dXJuIHBEYXRhOwoJfQoJaWYgKElzRnJhbWUocERhdGEsIGlsRGF0YUxlbikgPT0gZmFsc2UpCgl7CgkJcmV0dXJuIHBEYXRhOwoJfQoKCWludDMyX3QgaVRtaUZyYW1lU2l6ZSA9IDA7Cgl1aW50OF90KiBwTmV4dFB0ciA9IHBEYXRhOwoJaWYgKGlsRGF0YUxlbiAtIDEyNiA+IG1faUJ1ZmZlclNpemVEQikKCXsKCQlpZiAoSXNGcmFtZSgmcERhdGFbbV9pQnVmZmVyU2l6ZURCIC0gMl0sIGlsRGF0YUxlbiAtIG1faUJ1ZmZlclNpemVEQiAtIDIpKQoJCXsKCQkJaVRtaUZyYW1lU2l6ZSA9IG1faUJ1ZmZlclNpemVEQiAtIDI7CgkJfQoJCWVsc2UgewoJCQlpVG1pRnJhbWVTaXplID0gbV9pQnVmZmVyU2l6ZURCOwoJCX0KCQlwTmV4dFB0ciA9ICZwRGF0YVtpVG1pRnJhbWVTaXplXTsKCX0KCWVsc2UgewoJCWlmIChpbERhdGFMZW4gPD0gbV9pQnVmZmVyU2l6ZURCKQoJCXsKCQkJcE5leHRQdHIgPSBOVUxMOwoJCQlpVG1pRnJhbWVTaXplID0gaWxEYXRhTGVuOwoJCX0KCQllbHNlIAoJCXsKCQkJaVRtaUZyYW1lU2l6ZSA9IG1faUJ1ZmZlclNpemVEQjsKCQkJcE5leHRQdHIgPSAmcERhdGFbaVRtaUZyYW1lU2l6ZV07CgkJfQoJCWlUbWlGcmFtZVNpemUgPSBzdGQ6Om1pbjxpbnQzMl90PihpbERhdGFMZW4sIG1faUJ1ZmZlclNpemVEQik7Cgl9CglpZiAoaVRtaUZyYW1lU2l6ZSA+IDApCgl7CgkJc3RGcmFtZS5wRnJhbWVEYXRhID0gcERhdGE7CgkJc3RGcmFtZS5pRnJhbWVTaXplID0gaVRtaUZyYW1lU2l6ZTsKCX0KCglyZXR1cm4gcE5leHRQdHI7Cn0K
==H
I3ByYWdtYSBvbmNlCiNpbmNsdWRlIDxjc3RkaW50PgojaW5jbHVkZSA8dmVjdG9yPgojaW5jbHVkZSA8bWFwPgojaW5jbHVkZSA8c3RyaW5nPgojaW5jbHVkZSAiQ29tRnVuLmhwcCIKCi8v6I635Y+WIEgyNjTnvJbnoIFOQUznmoTljZXlhYPnsbvlnovvvIhVSU5UVFlQRe+8ieWNleWFg+exu+Wei+iMg+WbtOS4ujF+MjMg5qCH5YeG5Li6IDF+MTIKI2RlZmluZSBOQUxfVUlOVFRZUEUobmFsKSAoKG5hbCkmKDB4MUYpKQovL+iOt+WPliBIMjY057yW56CBTkFM55qE5LyY5YWI57qn77yIUkVGRVJFTkNFX0JJVO+8iQojZGVmaW5lIE5BTF9SRUZFUkVOQ0UobmFsKSAoKG5hbCkmKDB4NjApKQovL+iOt+WPliBIMjY057yW56CBTkFM55qE56aB5q2i5L2N77yIZm9yYmlkZGVyX2JpdO+8iQojZGVmaW5lIE5BTF9GT1JCSURERVIobmFsKSAoKG5hbCkmKDB4ODApKQpuYW1lc3BhY2UgTXA0UmVwYWlyIHsKCXVzaW5nIE5BTCA9IHVpbnQ4X3Q7CgoJY29uc3QgdWludDhfdCBBQzNfQVNOQ0hXT1JEID0gMHgwQjsKCWNvbnN0IHVpbnQ4X3QgQUMzX0FTTkNMV09SRCA9IDB4Nzc7Cgljb25zdCB1aW50OF90IEFDM19BU05DV09SRFsyXSA9IHsgQUMzX0FTTkNIV09SRCwgQUMzX0FTTkNMV09SRCB9OwoKCXR5cGVkZWYgc3RydWN0IF9EdW1wRnJhbWUKCXsKCQlzdGQ6Om1hcDxzdGQ6OnN0cmluZywgc3RkOjpzdHJpbmc+IG1wUGFyYW1zOwoJCXVpbnQ4X3QqIHBGcmFtZURhdGE7CgkJaW50MzJfdCBpRnJhbWVTaXplOwoJCV9EdW1wRnJhbWUodWludDhfdCogZGF0YSA9IG51bGxwdHIsIGludDY0X3Qgc2l6ZSA9IDApIDoKCQkJcEZyYW1lRGF0YShkYXRhKSwKCQkJaUZyYW1lU2l6ZShzaXplKSB7fTsKCX0gRHVtcEZyYW1lLCBETVBGUkFNRTsKCgljbGFzcyBDTXA0SDI2NFBhcnNlcnsKCXB1YmxpYzoKCQlib29sIElzRnJhbWUodWludDhfdCogcERhdGEsIGludDY0X3QgaWxEYXRhTGVuKTsKCQkvL+iOt+WPluW9k+WJjeW4p++8jOWmguaenOaIkOWKn+enu+WKqOWIsOS4i+S4gOS4quS9jee9ru+8jOWmguaenOWksei0pe+8jOS4jeenu+WKqOi/lOWbnuWOn+S9jee9ru+8jHN0RnJhbWXorr7nva7kuLrnqboKCQkvL+eJueWIq+azqOaEj++8jOWvueS6jk1QNOeahOinhumikeW4p++8jOi/lOWbnueahHN0RnJhbWXkuI3ljIXlkKvliY006KGo56S66ZW/5bqm55qE5a2X6IqCCgkJdWludDhfdCogR2V0RnJhbWVBbmROZXh0KERNUEZSQU1FJiBzdEZyYW1lLHVpbnQ4X3QqIHBEYXRhLCBpbnQ2NF90IGlsRGF0YUxlbik7Cgl9OwoKCWNsYXNzIENNcDRBQzNQYXJzZXIgewoJcHJpdmF0ZToKCQlpbnQgbV9pQnVmZmVyU2l6ZURCOwoJcHVibGljOgoJCUNNcDRBQzNQYXJzZXIoKTsKCXB1YmxpYzoKCgkJdm9pZCBTZXRCdWZmZXJTaXplREIoaW50IGlTaXplKTsKCgkJYm9vbCBJc0ZyYW1lKHVpbnQ4X3QqIHBEYXRhLCBpbnQ2NF90IGlsRGF0YUxlbik7CgkJLy/ojrflj5blvZPliY3luKfvvIzlpoLmnpzmiJDlip/np7vliqjliLDkuIvkuIDkuKrkvY3nva7vvIzlpoLmnpzlpLHotKXvvIzkuI3np7vliqjvvIxzdEZyYW1l6K6+572u5Li656m6CgkJdWludDhfdCogR2V0RnJhbWVBbmROZXh0KERNUEZSQU1FJiBzdEZyYW1lLCB1aW50OF90KiBwRGF0YSwgaW50NjRfdCBpbERhdGFMZW4pOwoJfTsKCgl1c2luZyBDTXA0RXh0cmFjdEZyYW1lcyA9IHN0ZDo6bWFwPHVpbnQzMl90LCBzdGQ6OnZlY3RvcjxETVBGUkFNRT4+OwoJY2xhc3MgQ01wNENvcnJ1cHRFeHRyYWN0Cgl7CglwdWJsaWM6CgkJQ01wNEgyNjRQYXJzZXIgbV9zdE1wNEgyNjRQYXJzZXI7CgkJQ01wNEFDM1BhcnNlciBtX3N0TXA0QUMzUGFyc2VyOwoJcHVibGljOgoJCUNNcDRDb3JydXB0RXh0cmFjdCgpOwoJCX5DTXA0Q29ycnVwdEV4dHJhY3QoKTsKCXB1YmxpYzoKCQl2b2lkIEV4dHJhY3QoQ01wNEV4dHJhY3RGcmFtZXMmIGZyYW1lcyx1aW50OF90KiBwRGF0YSxpbnQ2NF90IGlsRGF0YUxlbik7CglwdWJsaWM6CgkJaW50NjRfdCBEdW1wSDI2NFZpZGVvRnJhbWUodWludDhfdCogcERhdGEsIGludDY0X3QgaWxEYXRhTGVuLCBzdGQ6OnZlY3RvcjxETVBGUkFNRT4mIGZyYW1lcyk7CgkJaW50NjRfdCBEdW1wQUMzQXVkaW9GcmFtZSh1aW50OF90KiBwRGF0YSwgaW50NjRfdCBpbERhdGFMZW4sIHN0ZDo6dmVjdG9yPERNUEZSQU1FPiYgZnJhbWVzKTsKCX07CgkKfQoK
==
I2luY2x1ZGUgPHN0cmluZz4KI2luY2x1ZGUgPGlvc3RyZWFtPgoKI2luY2x1ZGUgPGZzdHJlYW0+CiNpbmNsdWRlIDxsaXN0PgojaW5jbHVkZSA8bWFwPgojaW5jbHVkZSA8bXV0ZXg+CiNpbmNsdWRlIDx0aHJlYWQ+CiNpbmNsdWRlIDxmdW5jdGlvbmFsPgojaW5jbHVkZSA8c3N0cmVhbT4KI2luY2x1ZGUgPGlvbWFuaXA+CgojaW5jbHVkZSAianNvbmNwcC9qc29uLmgiCgojaW5jbHVkZSAic29ja2V0Y3BwL1NvY2tldC5oIgojaW5jbHVkZSAiQ1RocmVhZFBvb2wuaCIKbmFtZXNwYWNlIFZpcFN5c3RlbQp7Cgl1c2luZyBzdGRzdHJpbmcgPSBzdGQ6OnN0cmluZzsKCWNvbnN0IGNoYXIqIFVTRVJJTkZPX0ZJTEVQQVRIID0gIkQ6L2luZm8udHh0IjsKCWNsYXNzIENUaHJlYWRMb2NrCgl7Cglwcml2YXRlOgoJCXN0ZDo6bXV0ZXggbV9tdHg7CgkJc3RkOjp0aHJlYWQ6OmlkIG1fQ3VyVGhyZWFkSWQ7CgkJdWludDMyX3QgbV9pTG9ja0xldmU7CglwdWJsaWM6CgkJQ1RocmVhZExvY2soKTsKCQl+Q1RocmVhZExvY2soKTsKCXB1YmxpYzoKCQl2b2lkIGxvY2soKTsKCQl2b2lkIHVubG9jaygpOwoJfTsKCglDVGhyZWFkTG9jazo6Q1RocmVhZExvY2soKQoJewoJCW1faUxvY2tMZXZlID0gMDsKCX0KCglDVGhyZWFkTG9jazo6fkNUaHJlYWRMb2NrKCkKCXsKCX0KCgl2b2lkIENUaHJlYWRMb2NrOjpsb2NrKCkKCXsKCQlpZiAobV9DdXJUaHJlYWRJZCAhPSBzdGQ6OnRoaXNfdGhyZWFkOjpnZXRfaWQoKSkKCQl7CgkJCW1fbXR4LmxvY2soKTsKCQl9CgkJbV9pTG9ja0xldmUrKzsKCQltX0N1clRocmVhZElkID0gc3RkOjp0aGlzX3RocmVhZDo6Z2V0X2lkKCk7Cgl9Cgl2b2lkIENUaHJlYWRMb2NrOjp1bmxvY2soKQoJewoJCWlmIChtX0N1clRocmVhZElkID09IHN0ZDo6dGhpc190aHJlYWQ6OmdldF9pZCgpKQoJCXsKCQkJbV9pTG9ja0xldmUtLTsKCQkJaWYgKG1faUxvY2tMZXZlID09IDApCgkJCXsKCQkJCW1fQ3VyVGhyZWFkSWQgPSBzdGQ6OnRocmVhZDo6aWQ6OmlkKCk7CgkJCQltX210eC51bmxvY2soKTsKCQkJfQoJCX0KCX0KCgljbGFzcyBDSWRNYW5hZ2VyIDogcHVibGljIENUaHJlYWRMb2NrCgl7CglwdWJsaWM6CgkJc3RhdGljIENJZE1hbmFnZXIqIEdldEluc3RhbmNlKCk7CglwdWJsaWM6CgkJQ0lkTWFuYWdlcigpOwoJcHVibGljOgoJCS8v55Sf5oiQ5LiA5LiqSUQKCQkvL0BwYXJhbSB0YWcgW2luXSBJROeahOWJjee8gO+8jOWmguaenOaMh+WumuS4uk5VTEzmiJbogIXnqbrlrZfnrKbkuLIg5bCG5LiN5Lqn55Sf5YmN57yACgkJLy9AcmV0dXJuIElE5a2X56ym5LiyCgkJc3Rkc3RyaW5nIEdldElEKGNvbnN0IGNoYXIqIHRhZyA9IE5VTEwpOwoJcHJpdmF0ZToKCQlpbnQgR2V0TmV4dElkTnVtYmVyKCk7CgkJaW50IG1faUlETnVtYmVyOwoJfTsKCglDSWRNYW5hZ2VyKiBDSWRNYW5hZ2VyOjpHZXRJbnN0YW5jZSgpCgl7CgkJc3RhdGljIENJZE1hbmFnZXIgY2xJZE1hbmFnZXI7CgkJcmV0dXJuICZjbElkTWFuYWdlcjsKCX0KCglDSWRNYW5hZ2VyOjpDSWRNYW5hZ2VyKCkKCXsKCQltX2lJRE51bWJlciA9IDA7Cgl9CgoJc3Rkc3RyaW5nIENJZE1hbmFnZXI6OkdldElEKGNvbnN0IGNoYXIqIHRhZykKCXsKCQl0aW1lX3QgdCA9IHRpbWUoMCk7CgkJY2hhciBzdHJMb2NhbFRpbWVbNjRdOwoJCXN0cmZ0aW1lKHN0ckxvY2FsVGltZSwgc2l6ZW9mKHN0ckxvY2FsVGltZSksICIlWSVtJWQlSCVNJVMiLCBsb2NhbHRpbWUoJnQpKTsKCQlzdGRzdHJpbmcgc3RySWQ7CgkJaWYgKHRhZyAhPSBOVUxMICYmIHRhZ1swXSAhPSAnXDAnKQoJCXsKCQkJc3RySWQgKz0gdGFnOwoJCQlzdHJJZCArPSAiLSI7CgkJfQoJCXN0cklkICs9IHN0ckxvY2FsVGltZTsKCQlzdHJJZCArPSAiLSI7CgkJc3RkOjpvc3RyaW5nc3RyZWFtIHNTdHI7CgkJc1N0ciA8PCBzdGQ6OnNldGZpbGwoJzAnKSA8PCBzdGQ6OnNldHcoOCkgPDwgc3RkOjpoZXggPDwgR2V0TmV4dElkTnVtYmVyKCk7CgkJc3RySWQgKz0gc1N0ci5zdHIoKTsKCQlyZXR1cm4gc3RySWQ7Cgl9CgkKCWludCBDSWRNYW5hZ2VyOjpHZXROZXh0SWROdW1iZXIoKQoJewoJCWxvY2soKTsgCgkJaW50IGlOdW1iZXIgPSBtX2lJRE51bWJlcjsKCQltX2lJRE51bWJlcisrOwoJCXVubG9jaygpOwoJCXJldHVybiBtX2lJRE51bWJlcjsKCX0KCQoJY2xhc3MgQ1VzZXJNYW5hZ2VyOnB1YmxpYyBDVGhyZWFkTG9jawoJewoJcHVibGljOgoJCXN0YXRpYyBDVXNlck1hbmFnZXIqIEdldEluc3RhbmNlKCk7CglwdWJsaWM6CgkJc3RhdGljIGNvbnN0IGNoYXIqIElORk9LRVlfSUQ7CgkJc3RhdGljIGNvbnN0IGNoYXIqIElORk9LRVlfU0VYOwoJCXN0YXRpYyBjb25zdCBjaGFyKiBJTkZPS0VZX05BTUU7CgkJc3RhdGljIGNvbnN0IGNoYXIqIElORk9LRVlfUEFTU1dPUkQ7CgkJc3RhdGljIGNvbnN0IGNoYXIqIElORk9LRVlfQUNDT1VOVDsKCQlzdGF0aWMgY29uc3QgY2hhciogSU5GT0tFWV9MQVNUVVBEQVRFUEFTU1RJTUU7IC8v5pyA5ZCO5pu05paw5a+G56CB55qE5pe26Ze0IOeUqOadpeagoemqjOaYr+WQpuabtOaUueS6huWvhueggQoJcHVibGljOgoJCS8v6YCa6L+HVXNlcklE5p+l5om+55So5oi3CgkJaW50IEdldFVzZXIoY29uc3Qgc3Rkc3RyaW5nJiBzdHJVc2VySUQsIEpzb246OlZhbHVlJiByZXN1bHQpOwoJCS8v6YCa6L+H6LSm5Y+35a+G56CB5p+l5om+55So5oi3CgkJaW50IEdldFVzZXIoY29uc3Qgc3Rkc3RyaW5nJiBzdHJBY2NvdW50LCBjb25zdCBzdGRzdHJpbmcmIHN0clBhc3N3b3JkLCBKc29uOjpWYWx1ZSYgcmVzdWx0KTsKCQkvL+afpeaJvueUqOaItwoJCS8vQHBhcmFtIHdoZXJlIFtpbl0g6L+H5ruk55qE5YWF5YiG5L2G5LiN5b+F6KaB5p2h5Lu2CgkJLy9AcGFyYW0gbGltaXQgW2luXSDmn6Xmib7nmoTkuKrmlbAKCQkvL0BwYXJhbSByZXN1bHQgW291dF0g6L6T5Ye657uT5p6cCgkJLy9AcmV0dXJuIOaJvuWIsOeahOS4quaVsAoJCWludCBHZXRVc2Vycyhjb25zdCBKc29uOjpWYWx1ZSYgd2hlcmUsaW50IGxpbWl0LCBzdGQ6OnZlY3RvcjxKc29uOjpWYWx1ZT4mIHJlc3VsdCk7CgkJYm9vbCBBZGRVc2VyKHN0ZHN0cmluZyYgc3RyVXNlcklELCBjb25zdCBKc29uOjpWYWx1ZSYgdXNlckluZm8pOwoJCXZvaWQgTW9kaWZ5VXNlcihjb25zdCBzdGRzdHJpbmcmIHN0clVzZXJJRCwgY29uc3QgSnNvbjo6VmFsdWUmIHVzZXJJbmZvKTsKCXB1YmxpYzoKCQlib29sIFVwZGF0ZSgpOwoJCWJvb2wgU2F2ZSgpOwoJcHJpdmF0ZToKCQlzdGQ6Om1hcDxzdGRzdHJpbmcsIEpzb246OlZhbHVlPiBtX21wVXNlcnM7CgkJLy9zdGQ6Omxpc3Q8SnNvbjo6VmFsdWUqPiBtX2xpVXNlcnM7Cgl9OwoKCWNvbnN0IGNoYXIqIENVc2VyTWFuYWdlcjo6SU5GT0tFWV9JRCA9ICJ1c2VyX2lkIjsKCWNvbnN0IGNoYXIqIENVc2VyTWFuYWdlcjo6SU5GT0tFWV9TRVggPSAidXNlcl9zZXgiOwoJY29uc3QgY2hhciogQ1VzZXJNYW5hZ2VyOjpJTkZPS0VZX05BTUUgPSAidXNlcl9uYW1lIjsKCWNvbnN0IGNoYXIqIENVc2VyTWFuYWdlcjo6SU5GT0tFWV9QQVNTV09SRCA9ICJ1c2VyX3Bhc3N3b3JkIjsKCWNvbnN0IGNoYXIqIENVc2VyTWFuYWdlcjo6SU5GT0tFWV9BQ0NPVU5UID0gInVzZXJfYWNjb3VudCI7Cgljb25zdCBjaGFyKiBDVXNlck1hbmFnZXI6OklORk9LRVlfTEFTVFVQREFURVBBU1NUSU1FID0gInVzZXJfbGFzdF9tb2RpZnlfcGFzc293cmRfdGltZSI7CgoJQ1VzZXJNYW5hZ2VyKiBDVXNlck1hbmFnZXI6OkdldEluc3RhbmNlKCkKCXsKCQlzdGF0aWMgQ1VzZXJNYW5hZ2VyIGNsTWFuYWdlcjsKCQlyZXR1cm4gJmNsTWFuYWdlcjsKCX0KCglpbnQgQ1VzZXJNYW5hZ2VyOjpHZXRVc2VyKGNvbnN0IHN0ZHN0cmluZyYgc3RyVXNlcklELCBKc29uOjpWYWx1ZSYgcmVzdWx0KQoJewoJCXN0ZDo6bG9ja19ndWFyZDxDVGhyZWFkTG9jaz4gX2xvY2tfdXNlKCp0aGlzKTsKCQlhdXRvIHJlZlVzZXIgPSBtX21wVXNlcnMuZmluZChzdHJVc2VySUQpOwoJCWlmIChyZWZVc2VyID09IG1fbXBVc2Vycy5lbmQoKSkKCQl7CgkJCXJldHVybiAwOwoJCX0KCQlyZXN1bHQgPSByZWZVc2VyLT5zZWNvbmQ7CgkJcmV0dXJuIDE7CgkJLyoKCQlzdGQ6OmxvY2tfZ3VhcmQ8Q1RocmVhZExvY2s+IF9sb2NrX3VzZSgqdGhpcyk7CgkJaW50IGlQaWNrQ291bnQgPSAwOwoJCWZvciAoYXV0byByZWZVc2VyID0gbV9tcFVzZXJzLmJlZ2luKCk7IHJlZlVzZXIgIT0gbV9tcFVzZXJzLmVuZCgpOyByZWZVc2VyKyspCgkJewoJCQlKc29uOjpWYWx1ZSYgdXNlciA9IHJlZlVzZXItPnNlY29uZDsKCQkJaWYgKHVzZXJbSU5GT0tFWV9JRF0uYXNDU3RyaW5nKCkgPT0gc3RyVXNlcklEKQoJCQl7CgkJCQlyZXN1bHQgPSB1c2VyOwoJCQkJaVBpY2tDb3VudCsrOwoJCQkJYnJlYWs7CgkJCX0KCQl9CgkJcmV0dXJuIGlQaWNrQ291bnQ7CgkJKi8KCX0KCglpbnQgQ1VzZXJNYW5hZ2VyOjpHZXRVc2VyKGNvbnN0IHN0ZHN0cmluZyYgc3RyQWNjb3VudCwgY29uc3Qgc3Rkc3RyaW5nJiBzdHJQYXNzd29yZCwgSnNvbjo6VmFsdWUmIHJlc3VsdCkKCXsKCQlzdGQ6OmxvY2tfZ3VhcmQ8Q1RocmVhZExvY2s+IF9sb2NrX3VzZSgqdGhpcyk7CgkJaW50IGlQaWNrQ291bnQgPSAwOwoJCWZvciAoYXV0byByZWZVc2VyID0gbV9tcFVzZXJzLmJlZ2luKCk7IHJlZlVzZXIgIT0gbV9tcFVzZXJzLmVuZCgpOyByZWZVc2VyKyspCgkJewoJCQlKc29uOjpWYWx1ZSYgdXNlciA9IHJlZlVzZXItPnNlY29uZDsKCQkJaWYgKHVzZXJbSU5GT0tFWV9BQ0NPVU5UXS5hc0NTdHJpbmcoKSA9PSBzdHJBY2NvdW50ICYmIHVzZXJbSU5GT0tFWV9QQVNTV09SRF0uYXNDU3RyaW5nKCkgPT0gc3RyUGFzc3dvcmQpCgkJCXsKCQkJCXJlc3VsdCA9IHVzZXI7CgkJCQlpUGlja0NvdW50Kys7CgkJCQlicmVhazsKCQkJfQoJCX0KCQlyZXR1cm4gaVBpY2tDb3VudDsKCX0KCglpbnQgQ1VzZXJNYW5hZ2VyOjpHZXRVc2Vycyhjb25zdCBKc29uOjpWYWx1ZSYgd2hlcmUsIGludCBsaW1pdCwgc3RkOjp2ZWN0b3I8SnNvbjo6VmFsdWU+JiB2ZWNSZXN1bHRVc2VycykKCXsKCQlzdGQ6OmxvY2tfZ3VhcmQ8Q1RocmVhZExvY2s+IF9sb2NrX3VzZSgqdGhpcyk7CgkJaW50IGlQaWNrQ291bnQgPSAwOwoJCWZvciAoYXV0byByZWZVc2VyID0gbV9tcFVzZXJzLmJlZ2luKCk7IHJlZlVzZXIgIT0gbV9tcFVzZXJzLmVuZCgpICYmIGxpbWl0ID4gaVBpY2tDb3VudDsgcmVmVXNlcisrKQoJCXsKCQkJSnNvbjo6VmFsdWUmIHVzZXIgPSByZWZVc2VyLT5zZWNvbmQ7CgkJCWZvciAoYXV0byByZWZXaGVyZU1lbWJlciA9IHdoZXJlLmJlZ2luKCk7IHJlZldoZXJlTWVtYmVyICE9IHdoZXJlLmVuZCgpOyByZWZXaGVyZU1lbWJlcisrKQoJCQl7CgkJCQlpZiAoIXVzZXIuaXNNZW1iZXIocmVmV2hlcmVNZW1iZXIubmFtZSgpKSkKCQkJCXsKCQkJCQljb250aW51ZTsKCQkJCX0KCQkJCUpzb246OlZhbHVlJiB1c2VyTWVtYmVyID0gdXNlcltyZWZXaGVyZU1lbWJlci5uYW1lKCldOwoJCQkJaWYgKHVzZXJNZW1iZXIudHlwZSgpICE9IHJlZldoZXJlTWVtYmVyLT50eXBlKCkpCgkJCQl7CgkJCQkJY29udGludWU7CgkJCQl9CgkJCQlpZiAocmVmV2hlcmVNZW1iZXItPmFzU3RyaW5nKCkgPT0gdXNlck1lbWJlci5hc1N0cmluZygpKQoJCQkJewoJCQkJCXZlY1Jlc3VsdFVzZXJzLnB1c2hfYmFjayh1c2VyKTsKCQkJCQlpUGlja0NvdW50Kys7CgkJCQl9CgkJCX0KCQl9CgkJcmV0dXJuIGlQaWNrQ291bnQ7Cgl9CgoJYm9vbCBDVXNlck1hbmFnZXI6OkFkZFVzZXIoc3Rkc3RyaW5nJiBzdHJVc2VySUQsIGNvbnN0IEpzb246OlZhbHVlJiB1c2VySW5mbykKCXsKCQlzdGQ6OmxvY2tfZ3VhcmQ8Q1RocmVhZExvY2s+IF9sb2NrX3VzZSgqdGhpcyk7CgkJc3Rkc3RyaW5nIHN0clVJRCA9IENJZE1hbmFnZXI6OkdldEluc3RhbmNlKCktPkdldElEKCJVSSIpOwoJCWF1dG8gcmVmVXNlciA9IG1fbXBVc2Vycy5pbnNlcnQoc3RkOjpwYWlyPHN0ZHN0cmluZywgSnNvbjo6VmFsdWU+KHN0clVJRCwgdXNlckluZm8pKTsKCQlKc29uOjpWYWx1ZSYgdXNlciA9IHJlZlVzZXIuZmlyc3QtPnNlY29uZDsKCQl1c2VyW0lORk9LRVlfSURdID0gc3RyVUlEOwoJCXN0clVzZXJJRCA9IHN0clVJRDsKCQkvL21fbGlVc2Vycy5wdXNoX2JhY2soJnVzZXIpOwoJCXJldHVybiB0cnVlOwoJfQoJdm9pZCBDVXNlck1hbmFnZXI6Ok1vZGlmeVVzZXIoY29uc3Qgc3Rkc3RyaW5nJiBzdHJVc2VySUQsIGNvbnN0IEpzb246OlZhbHVlJiB1c2VySW5mbykKCXsKCQlzdGQ6OmxvY2tfZ3VhcmQ8Q1RocmVhZExvY2s+IF9sb2NrX3VzZSgqdGhpcyk7CgkJYXV0byByZWZPbGRVc2VyID0gbV9tcFVzZXJzLmZpbmQoc3RyVXNlcklEKTsKCQlpZiAocmVmT2xkVXNlciA9PSBtX21wVXNlcnMuZW5kKCkpCgkJewoJCQlyZXR1cm47CgkJfQoJCWVsc2UKCQl7CgkJCUpzb246OlZhbHVlJiB1c2VyID0gcmVmT2xkVXNlci0+c2Vjb25kOwoJCQlmb3IgKGF1dG8gcmVmTmV3VXNlckluZm9NZW1iZXIgPSB1c2VySW5mby5iZWdpbigpOyByZWZOZXdVc2VySW5mb01lbWJlciAhPSB1c2VySW5mby5lbmQoKTsgcmVmTmV3VXNlckluZm9NZW1iZXIrKykKCQkJewoJCQkJLy9Vc2VySUTkuI3og73ov5vooYzmm7TmlLkKCQkJCWlmIChyZWZOZXdVc2VySW5mb01lbWJlci5uYW1lKCkgPT0gSU5GT0tFWV9JRCkKCQkJCXsKCQkJCQljb250aW51ZTsKCQkJCX0KCQkJCXVzZXJbcmVmTmV3VXNlckluZm9NZW1iZXIubmFtZSgpXSA9ICgqcmVmTmV3VXNlckluZm9NZW1iZXIpOwoJCQl9CgkJfQoJfQoJYm9vbCBDVXNlck1hbmFnZXI6OlVwZGF0ZSgpCgl7CgkJc3RkOjppZnN0cmVhbSBpRlN0cmVhbTsKCQlpRlN0cmVhbS5vcGVuKFVTRVJJTkZPX0ZJTEVQQVRILCBzdGQ6Omlvczo6YmluYXJ5IHwgc3RkOjppb3M6OmluKTsKCQlpZiAoIWlGU3RyZWFtLmlzX29wZW4oKSkKCQl7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJc3RkOjpzdHJpbmcgc3RyRG9jVGV4dDsKCQljaGFyIGJ1ZlsxMDI0XTsKCQltZW1zZXQoYnVmLCAwLCBzaXplb2YoYnVmKSk7CgkJaW50IGlSZWFkU2l6ZSA9IDA7CgkJd2hpbGUgKHRydWUpCgkJewoJCQlpRlN0cmVhbS5yZWFkKGJ1Ziwgc2l6ZW9mKGJ1ZikgLSAxKTsKCQkJaW50IGlTdWNSZWFkQ291bnQgPSBpRlN0cmVhbS5nY291bnQoKTsKCQkJYnVmW2lTdWNSZWFkQ291bnRdID0gJ1wwJzsKCQkJaVJlYWRTaXplICs9IGlTdWNSZWFkQ291bnQ7CgkJCS8vCgkJCWlmIChpU3VjUmVhZENvdW50ID4gMCkKCQkJewoJCQkJc3RyRG9jVGV4dCArPSBidWY7CgkJCX0KCQkJZWxzZQoJCQl7CgkJCQlicmVhazsKCQkJfQoJCQkvLyBlb2YKCQkJaWYgKGlTdWNSZWFkQ291bnQgIT0gKHNpemVvZihidWYpIC0gMSkpIAoJCQl7CgkJCQlicmVhazsKCQkJfQoJCQkvLyBpcyBtYXggCgkJCWlmIChpUmVhZFNpemUgPj0gMTA3Mzc0MTgyNCkgCgkJCXsKCQkJCWJyZWFrOwoJCQl9CgkJfQoJCWlGU3RyZWFtLmNsb3NlKCk7CgoJCUpzb246OlJlYWRlciByZWFkZXI7CgkJSnNvbjo6VmFsdWUgcm9vdDsKCQlib29sIGJQYXNlU3VjID0gcmVhZGVyLnBhcnNlKHN0ckRvY1RleHQsIHJvb3QpOwoJCWlmICghcm9vdC5pc0FycmF5KCkpCgkJewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJCXN0ZDo6bG9ja19ndWFyZDxDVGhyZWFkTG9jaz4gX2xvY2tfdXNlKCp0aGlzKTsKCQltX21wVXNlcnMuY2xlYXIoKTsKCQlmb3IgKGF1dG8gcmVmVXNlciA9IHJvb3QuYmVnaW4oKTsgcmVmVXNlciAhPSByb290LmVuZCgpOyByZWZVc2VyKyspCgkJewoJCQlpZiAocmVmVXNlci0+dHlwZSgpICE9IEpzb246OlZhbHVlVHlwZTo6b2JqZWN0VmFsdWUgfHwgIXJlZlVzZXItPmlzTWVtYmVyKElORk9LRVlfSUQpKQoJCQl7CgkJCQljb250aW51ZTsKCQkJfQoJCQlKc29uOjpWYWx1ZSYgdXNlcklkID0gKCpyZWZVc2VyKVtJTkZPS0VZX0lEXTsKCQkJaWYgKHVzZXJJZC50eXBlKCkgIT0gSnNvbjo6VmFsdWVUeXBlOjpzdHJpbmdWYWx1ZSkKCQkJewoJCQkJY29udGludWU7CgkJCX0KCQkJbV9tcFVzZXJzW3VzZXJJZC5hc1N0cmluZygpXSA9ICpyZWZVc2VyOwoJCX0KCQlyZXR1cm4gdHJ1ZTsKCX0KCWJvb2wgQ1VzZXJNYW5hZ2VyOjpTYXZlKCkKCXsKCQlKc29uOjpWYWx1ZSBqYXJyVXNlcnMoSnNvbjo6VmFsdWVUeXBlOjphcnJheVZhbHVlKTsKCQl7Ly/miZPljIXmiJBKU09O5pWw57uECgkJCXN0ZDo6bG9ja19ndWFyZDxDVGhyZWFkTG9jaz4gX2xvY2tfdXNlKCp0aGlzKTsKCQkJZm9yIChhdXRvIHJlZlVzZXIgPSBtX21wVXNlcnMuYmVnaW4oKTsgcmVmVXNlciAhPSBtX21wVXNlcnMuZW5kKCk7IHJlZlVzZXIrKykKCQkJewoJCQkJamFyclVzZXJzLmFwcGVuZChyZWZVc2VyLT5zZWNvbmQpOwoJCQl9CgkJfQoJCUpzb246OkZhc3RXcml0ZXIgIHdyaXRlcjsvL+WmguaenOS4jemcgOimgeaNouihjAoJCS8vSnNvbjo6U3R5bGVkV3JpdGVyIHdyaXRlcjsKCQlzdGQ6OnN0cmluZyBzdHJKc29uVXNlcnMgPSB3cml0ZXIud3JpdGUoamFyclVzZXJzKTsKCQkvL+S/neWtmOWIsOaWh+S7tgoJCXN0ZDo6b2ZzdHJlYW0gb0ZTdHJlYW07CgkJb0ZTdHJlYW0ub3BlbihVU0VSSU5GT19GSUxFUEFUSCwgc3RkOjppb3M6OmJpbmFyeSB8IHN0ZDo6aW9zOjpvdXQpOwoJCWlmICghb0ZTdHJlYW0uaXNfb3BlbigpKQoJCXsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQlvRlN0cmVhbS53cml0ZShzdHJKc29uVXNlcnMuY19zdHIoKSwgc3RySnNvblVzZXJzLmxlbmd0aCgpKTsKCQlvRlN0cmVhbS5jbG9zZSgpOwoJCXJldHVybiB0cnVlOwoJfQoJY29uc3QgaW50IFZJUFNZU19SRVNfU1RBVFVTX1NVQyA9IDIwMDsKCWNvbnN0IGludCBWSVBTWVNfUkVTX0NPREVfU1VDID0gMDsgCgljb25zdCBpbnQgVklQU1lTX1JFU19DT0RFX1VOS05PV04gPSAtMTsgLy/mnKrnn6XplJnor68KCWNvbnN0IGludCBWSVBTWVNfUkVTX0NPREVfQVBJTk9URk9ORCA9IC0yOyAvL0FQSeS4jeWtmOWcqAoJY29uc3QgaW50IFZJUFNZU19SRVNfQ09ERV9OT1RMT0dJTiA9IC0zOyAvL+acqueZu+W9lQoJY29uc3QgaW50IFZJUFNZU19SRVNfQ09ERV9BQ0NPVU5UQ0hFQ0tFUlIgPSAtMzsgLy/otKblj7fkv6Hmga/moKHpqozlpLHotKUg5Y+v6IO95piv5a+G56CB5pu05pS55LqGCgljb25zdCBpbnQgVklQU1lTX01BWF9OQU1FU0laRSA9IDEyNjsgLy/mnIDlpKflkI3np7Dplb/luqYKCWNvbnN0IGludCBWSVBTWVNfTUFYX1VTRVJNVUJFUlNJWkUgPSAyNTY7IC8v5pyA5aSn55So5oi35L+h5oGv5a2X5q616ZW/5bqmCgljb25zdCBjaGFyKiBWSVBTWVNfUkVTX1NUQVRVU0tFWSA9ICJzdGF0dXMiOwoJY29uc3QgY2hhciogVklQU1lTX1JFU19DT0RFS0VZID0gImNvZGUiOwoJY29uc3QgY2hhciogVklQU1lTX1JFU19FUlJNU0dLRVkgPSAiZXJybXNnIjsKCWNvbnN0IGNoYXIqIFZJUFNZU19SRVNfREFUQUtFWSA9ICJkYXRhIjsKCWNvbnN0IGNoYXIqIFZJUFNZU19SRVNfU0VTU0lPTktFWSA9ICJzZXNzaW9uIjsKCgljb25zdCBjaGFyKiBWSVBTWVNfUkVRX0FQSUtFWSA9ICJhcGkiOwoJY29uc3QgY2hhciogVklQU1lTX1JFUV9QQVJBTVNLRVkgPSAicGFyYW1zIjsKCWNvbnN0IGNoYXIqIFZJUFNZU19SRVFfU0VTU0lPTktFWSA9ICJzZXNzaW9uIjsKCWNsYXNzIENWaXBTeXN0ZW1TZXJ2ZXJBUElSZXF1ZXN0Cgl7Cglwcml2YXRlOgoJCXN0ZDo6c3RyaW5nIG1fc3RyU2Vzc2lvbklkOyAKCQlzdGQ6OnN0cmluZyBtX3N0ckFwaU5hbWU7IAoJCUpzb246OlZhbHVlIG1fanZhbFJlcVBhcmFtOwoJcHJpdmF0ZToKCQl2b2lkIGluaXQoY29uc3QgY2hhciogY3N0ckFwaU5hbWUsIGNvbnN0IEpzb246OlZhbHVlJiBqb2JqUGFyYW0sIGNvbnN0IGNoYXIqIGNzdHJTZXNzaW9uSWQpOwoJcHVibGljOgoJCUNWaXBTeXN0ZW1TZXJ2ZXJBUElSZXF1ZXN0KCk7CgkJQ1ZpcFN5c3RlbVNlcnZlckFQSVJlcXVlc3QoY29uc3QgY2hhciogY3N0ckFwaU5hbWUpOwoJCUNWaXBTeXN0ZW1TZXJ2ZXJBUElSZXF1ZXN0KGNvbnN0IGNoYXIqIGNzdHJBcGlOYW1lLGNvbnN0IEpzb246OlZhbHVlJiBqb2JqUGFyYW0sIGNvbnN0IGNoYXIqIGNzdHJTZXNzaW9uSWQgPSBOVUxMKTsKCQlDVmlwU3lzdGVtU2VydmVyQVBJUmVxdWVzdChjb25zdCBDVmlwU3lzdGVtU2VydmVyQVBJUmVxdWVzdCYgcik7CgkJQ1ZpcFN5c3RlbVNlcnZlckFQSVJlcXVlc3QoQ1ZpcFN5c3RlbVNlcnZlckFQSVJlcXVlc3QmJiByKSBub2V4Y2VwdDsKCQl+Q1ZpcFN5c3RlbVNlcnZlckFQSVJlcXVlc3QoKTsKCXB1YmxpYzoKCQl2b2lkIFNldEFwaU5hbWUoY29uc3QgY2hhciogY3N0cik7CgkJY29uc3QgY2hhciogR2V0QXBpTmFtZSgpIGNvbnN0OwoJCXZvaWQgU2V0U2Vzc2lvbklkKGNvbnN0IGNoYXIqIGNzdHIpOwoJCWNvbnN0IGNoYXIqIEdldFNlc3Npb25JZCgpIGNvbnN0OwoJCXZvaWQgU2V0UmVxUGFyYW0oY29uc3QgSnNvbjo6VmFsdWUmIGp2YWxQYXJhbSk7CgkJY29uc3QgSnNvbjo6VmFsdWUmIEdldFJlcVBhcmFtKCkgY29uc3Q7CglwdWJsaWM6CgkJSnNvbjo6VmFsdWUgVG9Kc29uKCkgY29uc3Q7CgkJYm9vbCBQYXJzZShjb25zdCBjaGFyKiBzdHJKc29uKTsKCXB1YmxpYzoKCQlDVmlwU3lzdGVtU2VydmVyQVBJUmVxdWVzdCYgb3BlcmF0b3I9KGNvbnN0IENWaXBTeXN0ZW1TZXJ2ZXJBUElSZXF1ZXN0JiByKTsKCQlDVmlwU3lzdGVtU2VydmVyQVBJUmVxdWVzdCYgb3BlcmF0b3I9KENWaXBTeXN0ZW1TZXJ2ZXJBUElSZXF1ZXN0JiYgcikgbm9leGNlcHQ7Cgl9OwoKCXZvaWQgQ1ZpcFN5c3RlbVNlcnZlckFQSVJlcXVlc3Q6OmluaXQoY29uc3QgY2hhciogY3N0ckFwaU5hbWUsIGNvbnN0IEpzb246OlZhbHVlJiBqb2JqUGFyYW0sIGNvbnN0IGNoYXIqIGNzdHJTZXNzaW9uSWQpCgl7CgkJaWYgKGNzdHJBcGlOYW1lKQoJCXsKCQkJbV9zdHJBcGlOYW1lID0gY3N0ckFwaU5hbWU7CgkJfQoJCWlmIChjc3RyU2Vzc2lvbklkKQoJCXsKCQkJbV9zdHJBcGlOYW1lID0gbV9zdHJTZXNzaW9uSWQ7CgkJfQoJCWlmICgham9ialBhcmFtLmlzTnVsbCgpKQoJCXsKCQkJbV9qdmFsUmVxUGFyYW0gPSBqb2JqUGFyYW07CgkJfQoJfQoKCUNWaXBTeXN0ZW1TZXJ2ZXJBUElSZXF1ZXN0OjpDVmlwU3lzdGVtU2VydmVyQVBJUmVxdWVzdCgpCgl7CgkJaW5pdChOVUxMLCBKc29uOjpWYWx1ZTo6bnVsbCwgTlVMTCk7Cgl9CgoJQ1ZpcFN5c3RlbVNlcnZlckFQSVJlcXVlc3Q6OkNWaXBTeXN0ZW1TZXJ2ZXJBUElSZXF1ZXN0KGNvbnN0IGNoYXIqIGNzdHJBcGlOYW1lKQoJewoJCWluaXQoY3N0ckFwaU5hbWUsIEpzb246OlZhbHVlOjpudWxsLCBOVUxMKTsKCX0KCglDVmlwU3lzdGVtU2VydmVyQVBJUmVxdWVzdDo6Q1ZpcFN5c3RlbVNlcnZlckFQSVJlcXVlc3QoY29uc3QgY2hhciogY3N0ckFwaU5hbWUsIGNvbnN0IEpzb246OlZhbHVlJiBqb2JqUGFyYW0sIGNvbnN0IGNoYXIqIGNzdHJTZXNzaW9uSWQpCgl7CgkJaW5pdChjc3RyQXBpTmFtZSwgam9ialBhcmFtLCBjc3RyU2Vzc2lvbklkKTsKCX0KCglDVmlwU3lzdGVtU2VydmVyQVBJUmVxdWVzdDo6Q1ZpcFN5c3RlbVNlcnZlckFQSVJlcXVlc3QoY29uc3QgQ1ZpcFN5c3RlbVNlcnZlckFQSVJlcXVlc3QmIHIpCgl7CgkJbV9zdHJTZXNzaW9uSWQgPSByLm1fc3RyU2Vzc2lvbklkOwoJCW1fc3RyQXBpTmFtZSA9IHIubV9zdHJBcGlOYW1lOwoJCW1fanZhbFJlcVBhcmFtID0gci5tX2p2YWxSZXFQYXJhbTsKCX0KCglDVmlwU3lzdGVtU2VydmVyQVBJUmVxdWVzdDo6Q1ZpcFN5c3RlbVNlcnZlckFQSVJlcXVlc3QoQ1ZpcFN5c3RlbVNlcnZlckFQSVJlcXVlc3QmJiByKSBub2V4Y2VwdAoJewoJCW1fc3RyU2Vzc2lvbklkID0gc3RkOjptb3ZlKHIubV9zdHJTZXNzaW9uSWQpOwoJCW1fc3RyQXBpTmFtZSA9IHN0ZDo6bW92ZShyLm1fc3RyQXBpTmFtZSk7CgkJbV9qdmFsUmVxUGFyYW0gPSBzdGQ6Om1vdmUoci5tX2p2YWxSZXFQYXJhbSk7Cgl9CgoJQ1ZpcFN5c3RlbVNlcnZlckFQSVJlcXVlc3Q6On5DVmlwU3lzdGVtU2VydmVyQVBJUmVxdWVzdCgpCgl7Cgl9CgoJdm9pZCBDVmlwU3lzdGVtU2VydmVyQVBJUmVxdWVzdDo6U2V0QXBpTmFtZShjb25zdCBjaGFyKiBjc3RyKQoJewoJCWlmIChjc3RyKQoJCXsKCQkJbV9zdHJBcGlOYW1lID0gY3N0cjsKCQl9Cgl9CgoJY29uc3QgY2hhciogQ1ZpcFN5c3RlbVNlcnZlckFQSVJlcXVlc3Q6OkdldEFwaU5hbWUoKSBjb25zdAoJewoJCXJldHVybiBtX3N0ckFwaU5hbWUuY19zdHIoKTsKCX0KCgl2b2lkIENWaXBTeXN0ZW1TZXJ2ZXJBUElSZXF1ZXN0OjpTZXRTZXNzaW9uSWQoY29uc3QgY2hhciogY3N0cikKCXsKCQlpZiAoY3N0cikKCQl7CgkJCW1fc3RyU2Vzc2lvbklkID0gY3N0cjsKCQl9Cgl9CgoJY29uc3QgY2hhciogQ1ZpcFN5c3RlbVNlcnZlckFQSVJlcXVlc3Q6OkdldFNlc3Npb25JZCgpIGNvbnN0Cgl7CgkJcmV0dXJuIG1fc3RyU2Vzc2lvbklkLmNfc3RyKCk7Cgl9CgoJdm9pZCBDVmlwU3lzdGVtU2VydmVyQVBJUmVxdWVzdDo6U2V0UmVxUGFyYW0oY29uc3QgSnNvbjo6VmFsdWUmIGp2YWxQYXJhbSkKCXsKCQltX2p2YWxSZXFQYXJhbSA9IGp2YWxQYXJhbTsKCX0KCgljb25zdCBKc29uOjpWYWx1ZSYgQ1ZpcFN5c3RlbVNlcnZlckFQSVJlcXVlc3Q6OkdldFJlcVBhcmFtKCkgY29uc3QKCXsKCQlyZXR1cm4gbV9qdmFsUmVxUGFyYW07Cgl9CgoJSnNvbjo6VmFsdWUgQ1ZpcFN5c3RlbVNlcnZlckFQSVJlcXVlc3Q6OlRvSnNvbigpIGNvbnN0Cgl7CgkJSnNvbjo6VmFsdWUgam9ialJlcyhKc29uOjpvYmplY3RWYWx1ZSk7CgkJam9ialJlc1tWSVBTWVNfUkVRX0FQSUtFWV0gPSBtX3N0ckFwaU5hbWU7CgkJam9ialJlc1tWSVBTWVNfUkVRX1NFU1NJT05LRVldID0gbV9zdHJTZXNzaW9uSWQ7CgkJaWYgKCFtX2p2YWxSZXFQYXJhbS5pc051bGwoKSkKCQl7CgkJCWpvYmpSZXNbVklQU1lTX1JFUV9QQVJBTVNLRVldID0gbV9qdmFsUmVxUGFyYW07CgkJfQoJCXJldHVybiBqb2JqUmVzOwoJfQoKCWJvb2wgQ1ZpcFN5c3RlbVNlcnZlckFQSVJlcXVlc3Q6OlBhcnNlKGNvbnN0IGNoYXIqIHN0ckpzb24pCgl7CgkJSnNvbjo6UmVhZGVyIHJlbmRlcjsKCQlKc29uOjpWYWx1ZSBqb2JqUmVzOwoJCWlmICghcmVuZGVyLnBhcnNlKHN0ckpzb24sIGpvYmpSZXMpKQoJCXsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQlpZiAoIWpvYmpSZXMuaXNPYmplY3QoKSkKCQl7CgkJCXJldHVybiBmYWxzZTsKCQl9CgkJbV9zdHJBcGlOYW1lID0gIiI7CgkJaWYgKGpvYmpSZXMuaXNNZW1iZXIoVklQU1lTX1JFUV9BUElLRVkpKQoJCXsKCQkJYXV0byYganZhbFRtcCA9IGpvYmpSZXNbVklQU1lTX1JFUV9BUElLRVldOwoJCQlpZiAoanZhbFRtcC5pc1N0cmluZygpKQoJCQl7CgkJCQltX3N0ckFwaU5hbWUgPSBqdmFsVG1wLmFzU3RyaW5nKCk7CgkJCX0KCQl9CgkJbV9zdHJTZXNzaW9uSWQgPSAiIjsKCQlpZiAoam9ialJlcy5pc01lbWJlcihWSVBTWVNfUkVRX1NFU1NJT05LRVkpKQoJCXsKCQkJYXV0byYganZhbFRtcCA9IGpvYmpSZXNbVklQU1lTX1JFUV9TRVNTSU9OS0VZXTsKCQkJaWYgKGp2YWxUbXAuaXNTdHJpbmcoKSkKCQkJewoJCQkJbV9zdHJTZXNzaW9uSWQgPSBqdmFsVG1wLmFzU3RyaW5nKCk7CgkJCX0KCQl9CgkJbV9qdmFsUmVxUGFyYW0gPSBKc29uOjpWYWx1ZTo6bnVsbDsKCQlpZiAoam9ialJlcy5pc01lbWJlcihWSVBTWVNfUkVRX1BBUkFNU0tFWSkpCgkJewoJCQlhdXRvJiBqdmFsVG1wID0gam9ialJlc1tWSVBTWVNfUkVRX1BBUkFNU0tFWV07CgkJCW1fanZhbFJlcVBhcmFtID0ganZhbFRtcDsKCQl9CgkJcmV0dXJuIHRydWU7Cgl9CgoJQ1ZpcFN5c3RlbVNlcnZlckFQSVJlcXVlc3QmIENWaXBTeXN0ZW1TZXJ2ZXJBUElSZXF1ZXN0OjpvcGVyYXRvcj0oY29uc3QgQ1ZpcFN5c3RlbVNlcnZlckFQSVJlcXVlc3QmIHIpCgl7CgkJbV9zdHJTZXNzaW9uSWQgPSByLm1fc3RyU2Vzc2lvbklkOwoJCW1fc3RyQXBpTmFtZSA9IHIubV9zdHJBcGlOYW1lOwoJCW1fanZhbFJlcVBhcmFtID0gci5tX2p2YWxSZXFQYXJhbTsKCQlyZXR1cm4gKnRoaXM7Cgl9CgoJQ1ZpcFN5c3RlbVNlcnZlckFQSVJlcXVlc3QmIENWaXBTeXN0ZW1TZXJ2ZXJBUElSZXF1ZXN0OjpvcGVyYXRvcj0oQ1ZpcFN5c3RlbVNlcnZlckFQSVJlcXVlc3QmJiByKSBub2V4Y2VwdAoJewoJCW1fc3RyU2Vzc2lvbklkID0gc3RkOjptb3ZlKHIubV9zdHJTZXNzaW9uSWQpOwoJCW1fc3RyQXBpTmFtZSA9IHN0ZDo6bW92ZShyLm1fc3RyQXBpTmFtZSk7CgkJbV9qdmFsUmVxUGFyYW0gPSBzdGQ6Om1vdmUoci5tX2p2YWxSZXFQYXJhbSk7CgkJcmV0dXJuICp0aGlzOwoJfQoKCWNsYXNzIENWaXBTeXN0ZW1TZXJ2ZXJBUElSZXN1bHQKCXsKCXByaXZhdGU6CgkJaW50IG1faVN0YXR1czsKCQlpbnQgbV9pQ29kZTsKCQlzdGQ6OnN0cmluZyBtX3N0ckVycm9yTXNnOwoJCXN0ZDo6c3RyaW5nIG1fc3RyU2Vzc2lvbklkOwoJCUpzb246OlZhbHVlIG1fanZhbFJlc0RhdGE7Cglwcml2YXRlOgoJCXZvaWQgaW5pdChpbnQgaVN0YXR1cywgaW50IGlDb2RlLCBjb25zdCBjaGFyKiBzdHJNc2cpOwoJcHVibGljOgoJCUNWaXBTeXN0ZW1TZXJ2ZXJBUElSZXN1bHQoaW50IGlDb2RlLGNvbnN0IGNoYXIqIHN0ckVyck1zZyk7CgkJQ1ZpcFN5c3RlbVNlcnZlckFQSVJlc3VsdChjb25zdCBKc29uOjpWYWx1ZSYganZhbERhdGEpOwoJCUNWaXBTeXN0ZW1TZXJ2ZXJBUElSZXN1bHQoQ1ZpcFN5c3RlbVNlcnZlckFQSVJlc3VsdCYmIHIpIG5vZXhjZXB0OwoJCUNWaXBTeXN0ZW1TZXJ2ZXJBUElSZXN1bHQoY29uc3QgQ1ZpcFN5c3RlbVNlcnZlckFQSVJlc3VsdCYgcik7CgkJQ1ZpcFN5c3RlbVNlcnZlckFQSVJlc3VsdCgpOwoJcHVibGljOgoJCXZvaWQgU2V0U3RhdHVzKGludCBpU3RhdHVzKTsKCQlpbnQgR2V0U3RhdHVzKCkgY29uc3Q7CgkJdm9pZCBTZXRDb2RlKGludCBpQ29kZSk7CgkJaW50IEdldENvZGUoKSBjb25zdDsKCQl2b2lkIFNldEVycm9yTXNnKGNvbnN0IGNoYXIqIGNzdHJNc2cpOwoJCWNvbnN0IGNoYXIqIEdldEVycm9yTXNnKCkgY29uc3Q7CgkJdm9pZCBTZXRTZXNzaW9uSWQoY29uc3QgY2hhciogY3N0cik7CgkJY29uc3QgY2hhciogR2V0U2Vzc2lvbklkKCkgY29uc3Q7CgkJdm9pZCBTZXRSZXNEYXRhKGNvbnN0IEpzb246OlZhbHVlJiBqdmFsRGF0YSk7CgkJY29uc3QgSnNvbjo6VmFsdWUmIEdldFJlc0RhdGEoKSBjb25zdDsKCXB1YmxpYzoKCQlKc29uOjpWYWx1ZSBUb0pzb24oKSBjb25zdDsKCQlib29sIFBhcnNlKGNvbnN0IGNoYXIqIHN0ckpzb24pOwoJcHVibGljOgoJCUNWaXBTeXN0ZW1TZXJ2ZXJBUElSZXN1bHQmIG9wZXJhdG9yPShjb25zdCBDVmlwU3lzdGVtU2VydmVyQVBJUmVzdWx0JiByKTsKCQlDVmlwU3lzdGVtU2VydmVyQVBJUmVzdWx0JiBvcGVyYXRvcj0oQ1ZpcFN5c3RlbVNlcnZlckFQSVJlc3VsdCYmIHIpIG5vZXhjZXB0OwoJfTsKCgl2b2lkIENWaXBTeXN0ZW1TZXJ2ZXJBUElSZXN1bHQ6OmluaXQoaW50IGlTdGF0dXMsIGludCBpQ29kZSwgY29uc3QgY2hhciogc3RyTXNnKQoJewoJCW1faVN0YXR1cyA9IGlTdGF0dXM7CgkJbV9pQ29kZSA9IGlDb2RlOwoJCWlmIChzdHJNc2cgIT0gTlVMTCkKCQl7CgkJCW1fc3RyRXJyb3JNc2cgPSBzdHJNc2c7CgkJfQoJfQoJQ1ZpcFN5c3RlbVNlcnZlckFQSVJlc3VsdDo6Q1ZpcFN5c3RlbVNlcnZlckFQSVJlc3VsdChpbnQgaUNvZGUsIGNvbnN0IGNoYXIqIHN0ckVyck1zZykKCXsKCQlpbml0KFZJUFNZU19SRVNfU1RBVFVTX1NVQywgaUNvZGUsIHN0ckVyck1zZyk7Cgl9CglDVmlwU3lzdGVtU2VydmVyQVBJUmVzdWx0OjpDVmlwU3lzdGVtU2VydmVyQVBJUmVzdWx0KGNvbnN0IEpzb246OlZhbHVlJiBqdmFsRGF0YSkKCXsKCQlpbml0KFZJUFNZU19SRVNfU1RBVFVTX1NVQywgVklQU1lTX1JFU19DT0RFX1NVQywgIiIpOwoJCW1fanZhbFJlc0RhdGEgPSBqdmFsRGF0YTsKCX0KCUNWaXBTeXN0ZW1TZXJ2ZXJBUElSZXN1bHQ6OkNWaXBTeXN0ZW1TZXJ2ZXJBUElSZXN1bHQoQ1ZpcFN5c3RlbVNlcnZlckFQSVJlc3VsdCYmIHIpIG5vZXhjZXB0Cgl7CgkJbV9pQ29kZSA9IHIubV9pQ29kZTsKCQltX2lTdGF0dXMgPSByLm1faVN0YXR1czsKCQltX3N0ckVycm9yTXNnID0gc3RkOjptb3ZlKHIubV9zdHJFcnJvck1zZyk7CgkJbV9zdHJTZXNzaW9uSWQgPSBzdGQ6Om1vdmUoci5tX3N0clNlc3Npb25JZCk7CgkJbV9qdmFsUmVzRGF0YSA9IHN0ZDo6bW92ZShyLm1fanZhbFJlc0RhdGEpOwoJfQoJQ1ZpcFN5c3RlbVNlcnZlckFQSVJlc3VsdDo6Q1ZpcFN5c3RlbVNlcnZlckFQSVJlc3VsdChjb25zdCBDVmlwU3lzdGVtU2VydmVyQVBJUmVzdWx0JiByKQoJewoJCW1faUNvZGUgPSByLm1faUNvZGU7CgkJbV9pU3RhdHVzID0gci5tX2lTdGF0dXM7CgkJbV9zdHJFcnJvck1zZyA9IHIubV9zdHJFcnJvck1zZzsKCQltX3N0clNlc3Npb25JZCA9IHIubV9zdHJTZXNzaW9uSWQ7CgkJbV9qdmFsUmVzRGF0YSA9IHIubV9qdmFsUmVzRGF0YTsKCX0KCUNWaXBTeXN0ZW1TZXJ2ZXJBUElSZXN1bHQ6OkNWaXBTeXN0ZW1TZXJ2ZXJBUElSZXN1bHQoKQoJewoJCWluaXQoVklQU1lTX1JFU19TVEFUVVNfU1VDLCBWSVBTWVNfUkVTX0NPREVfU1VDLCAiIik7Cgl9CgoJdm9pZCBDVmlwU3lzdGVtU2VydmVyQVBJUmVzdWx0OjpTZXRTdGF0dXMoaW50IGlTdGF0dXMpCgl7CgkJbV9pU3RhdHVzID0gaVN0YXR1czsKCX0KCglpbnQgQ1ZpcFN5c3RlbVNlcnZlckFQSVJlc3VsdDo6R2V0U3RhdHVzKCkgY29uc3QKCXsKCQlyZXR1cm4gbV9pU3RhdHVzOwoJfQoKCXZvaWQgQ1ZpcFN5c3RlbVNlcnZlckFQSVJlc3VsdDo6U2V0Q29kZShpbnQgaUNvZGUpCgl7CgkJbV9pQ29kZSA9IGlDb2RlOwoJfQoKCWludCBDVmlwU3lzdGVtU2VydmVyQVBJUmVzdWx0OjpHZXRDb2RlKCkgY29uc3QKCXsKCQlyZXR1cm4gbV9pQ29kZTsKCX0KCgl2b2lkIENWaXBTeXN0ZW1TZXJ2ZXJBUElSZXN1bHQ6OlNldEVycm9yTXNnKGNvbnN0IGNoYXIqIGNzdHJNc2cpCgl7CgkJaWYgKGNzdHJNc2cgPT0gTlVMTCkKCQl7CgkJCW1fc3RyRXJyb3JNc2cgPSAiIjsKCQl9CgkJZWxzZQoJCXsKCQkJbV9zdHJFcnJvck1zZyA9IGNzdHJNc2c7CgkJfQoJfQoKCWNvbnN0IGNoYXIqIENWaXBTeXN0ZW1TZXJ2ZXJBUElSZXN1bHQ6OkdldEVycm9yTXNnKCkgY29uc3QKCXsKCQlyZXR1cm4gbV9zdHJFcnJvck1zZy5jX3N0cigpOwoJfQoKCXZvaWQgQ1ZpcFN5c3RlbVNlcnZlckFQSVJlc3VsdDo6U2V0U2Vzc2lvbklkKGNvbnN0IGNoYXIqIGNzdHIpCgl7CgkJaWYgKGNzdHIgPT0gTlVMTCkKCQl7CgkJCW1fc3RyU2Vzc2lvbklkID0gIiI7CgkJfQoJCWVsc2UKCQl7CgkJCW1fc3RyU2Vzc2lvbklkID0gY3N0cjsKCQl9Cgl9CgoJY29uc3QgY2hhciogQ1ZpcFN5c3RlbVNlcnZlckFQSVJlc3VsdDo6R2V0U2Vzc2lvbklkKCkgY29uc3QKCXsKCQlyZXR1cm4gbV9zdHJTZXNzaW9uSWQuY19zdHIoKTsKCX0KCgl2b2lkIENWaXBTeXN0ZW1TZXJ2ZXJBUElSZXN1bHQ6OlNldFJlc0RhdGEoY29uc3QgSnNvbjo6VmFsdWUmIGp2YWxEYXRhKQoJewoJCW1fanZhbFJlc0RhdGEgPSBqdmFsRGF0YTsKCX0KCWNvbnN0IEpzb246OlZhbHVlJiBDVmlwU3lzdGVtU2VydmVyQVBJUmVzdWx0OjpHZXRSZXNEYXRhKCkgY29uc3QKCXsKCQlyZXR1cm4gbV9qdmFsUmVzRGF0YTsKCX0KCglKc29uOjpWYWx1ZSBDVmlwU3lzdGVtU2VydmVyQVBJUmVzdWx0OjpUb0pzb24oKSBjb25zdAoJewoJCUpzb246OlZhbHVlIGpvYmpSZXMoSnNvbjo6b2JqZWN0VmFsdWUpOwoJCWpvYmpSZXNbVklQU1lTX1JFU19TVEFUVVNLRVldID0gbV9pU3RhdHVzOwoJCWpvYmpSZXNbVklQU1lTX1JFU19DT0RFS0VZXSA9IG1faUNvZGU7CgkJam9ialJlc1tWSVBTWVNfUkVTX0VSUk1TR0tFWV0gPSBtX3N0ckVycm9yTXNnOwoJCWpvYmpSZXNbVklQU1lTX1JFU19TRVNTSU9OS0VZXSA9IG1fc3RyU2Vzc2lvbklkOwoJCWlmICghbV9qdmFsUmVzRGF0YS5pc051bGwoKSkKCQl7CgkJCWpvYmpSZXNbVklQU1lTX1JFU19EQVRBS0VZXSA9IG1fanZhbFJlc0RhdGE7CgkJfQoJCXJldHVybiBqb2JqUmVzOwoJfQoKCWJvb2wgQ1ZpcFN5c3RlbVNlcnZlckFQSVJlc3VsdDo6UGFyc2UoY29uc3QgY2hhciogc3RySnNvbikKCXsKCQlKc29uOjpSZWFkZXIgcmVuZGVyOwoJCUpzb246OlZhbHVlIGpvYmpSZXM7CgkJaWYgKCFyZW5kZXIucGFyc2Uoc3RySnNvbiwgam9ialJlcykpCgkJewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJCWlmICgham9ialJlcy5pc09iamVjdCgpKQoJCXsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQltX2lTdGF0dXMgPSBWSVBTWVNfUkVTX1NUQVRVU19TVUM7CgkJaWYgKGpvYmpSZXMuaXNNZW1iZXIoVklQU1lTX1JFU19TVEFUVVNLRVkpKQoJCXsKCQkJYXV0byYganZhbFRtcCA9IGpvYmpSZXNbVklQU1lTX1JFU19TVEFUVVNLRVldOwoJCQlpZiAoanZhbFRtcC5pc0ludCgpKQoJCQl7CgkJCQltX2lTdGF0dXMgPSBqdmFsVG1wLmFzSW50KCk7CgkJCX0KCQl9CgkJbV9pQ29kZSA9IFZJUFNZU19SRVNfQ09ERV9TVUM7CgkJaWYgKGpvYmpSZXMuaXNNZW1iZXIoVklQU1lTX1JFU19DT0RFS0VZKSkKCQl7CgkJCWF1dG8mIGp2YWxUbXAgPSBqb2JqUmVzW1ZJUFNZU19SRVNfQ09ERUtFWV07CgkJCWlmIChqdmFsVG1wLmlzSW50KCkpCgkJCXsKCQkJCW1faUNvZGUgPSBqdmFsVG1wLmFzSW50KCk7CgkJCX0KCQl9CgkJbV9zdHJFcnJvck1zZyA9ICIiOwoJCWlmIChqb2JqUmVzLmlzTWVtYmVyKFZJUFNZU19SRVNfRVJSTVNHS0VZKSkKCQl7CgkJCWF1dG8mIGp2YWxUbXAgPSBqb2JqUmVzW1ZJUFNZU19SRVNfRVJSTVNHS0VZXTsKCQkJaWYgKGp2YWxUbXAuaXNTdHJpbmcoKSkKCQkJewoJCQkJbV9zdHJFcnJvck1zZyA9IGp2YWxUbXAuYXNTdHJpbmcoKTsKCQkJfQoJCX0KCQltX3N0clNlc3Npb25JZCA9ICIiOwoJCWlmIChqb2JqUmVzLmlzTWVtYmVyKFZJUFNZU19SRVNfU0VTU0lPTktFWSkpCgkJewoJCQlhdXRvJiBqdmFsVG1wID0gam9ialJlc1tWSVBTWVNfUkVTX1NFU1NJT05LRVldOwoJCQlpZiAoanZhbFRtcC5pc1N0cmluZygpKQoJCQl7CgkJCQltX3N0clNlc3Npb25JZCA9IGp2YWxUbXAuYXNTdHJpbmcoKTsKCQkJfQoJCX0KCQltX2p2YWxSZXNEYXRhID0gSnNvbjo6VmFsdWU6Om51bGw7CgkJaWYgKGpvYmpSZXMuaXNNZW1iZXIoVklQU1lTX1JFU19EQVRBS0VZKSkKCQl7CgkJCWF1dG8mIGp2YWxUbXAgPSBqb2JqUmVzW1ZJUFNZU19SRVNfREFUQUtFWV07CgkJCW1fanZhbFJlc0RhdGEgPSBqdmFsVG1wOwoJCX0KCQlyZXR1cm4gdHJ1ZTsKCX0KCglDVmlwU3lzdGVtU2VydmVyQVBJUmVzdWx0JiBDVmlwU3lzdGVtU2VydmVyQVBJUmVzdWx0OjpvcGVyYXRvcj0oY29uc3QgQ1ZpcFN5c3RlbVNlcnZlckFQSVJlc3VsdCYgcikKCXsKCQltX2lDb2RlID0gci5tX2lDb2RlOwoJCW1faVN0YXR1cyA9IHIubV9pU3RhdHVzOwoJCW1fc3RyRXJyb3JNc2cgPSByLm1fc3RyRXJyb3JNc2c7CgkJbV9zdHJTZXNzaW9uSWQgPSByLm1fc3RyU2Vzc2lvbklkOwoJCW1fanZhbFJlc0RhdGEgPSByLm1fanZhbFJlc0RhdGE7CgkJcmV0dXJuICp0aGlzOwoJfQoJQ1ZpcFN5c3RlbVNlcnZlckFQSVJlc3VsdCYgQ1ZpcFN5c3RlbVNlcnZlckFQSVJlc3VsdDo6b3BlcmF0b3I9KENWaXBTeXN0ZW1TZXJ2ZXJBUElSZXN1bHQmJiByKSBub2V4Y2VwdAoJewoJCW1faUNvZGUgPSByLm1faUNvZGU7CgkJbV9pU3RhdHVzID0gci5tX2lTdGF0dXM7CgkJbV9zdHJFcnJvck1zZyA9IHN0ZDo6bW92ZShyLm1fc3RyRXJyb3JNc2cpOwoJCW1fc3RyU2Vzc2lvbklkID0gc3RkOjptb3ZlKHIubV9zdHJTZXNzaW9uSWQpOwoJCW1fanZhbFJlc0RhdGEgPSBzdGQ6Om1vdmUoci5tX2p2YWxSZXNEYXRhKTsKCQlyZXR1cm4gKnRoaXM7Cgl9CgljbGFzcyBDVmlwU3lzdGVtU2VydmVyCgl7Cglwcml2YXRlOgoJCWJvb2wgbV9iUnVuaW5nOwoJCS8vU29ja2V0U2VydmVyKiBtX1NvY2s7CgkJaW50IG1faVBvcnQ7CgkJaW50IG1faUNvbm5lY3Rpb25zOwoJCXN0ZDo6bWFwPHN0ZDo6c3RyaW5nLCBKc29uOjpWYWx1ZT4gbV9tcFNlc3Npb25zOwoJCUNUaHJlYWRMb2NrIG1fU2Vzc2lvbnNMb2NrOwoJCWludCBtX2lBdXRvU2F2ZVRpbWVPdXQ7CgkJLy9DVGhyZWFkUG9vbCogbV9UaHJlYWRQb29sOwoJcHVibGljOgoJCUNWaXBTeXN0ZW1TZXJ2ZXIoKTsKCQl+Q1ZpcFN5c3RlbVNlcnZlcigpOwoJcHVibGljOgoJCWludCBSdW5sb29wKCk7CgkJdm9pZCBTdG9wKCk7CgkJdm9pZCBTZXRBdXRvU2F2ZVRpbWVPdXQoaW50IGlBdXRvU2F2ZVRpbWUpOwoJCWludCBHZXRBdXRvU2F2ZVRpbWVPdXQoKTsKCXB1YmxpYzoKCQl2aXJ0dWFsIHZvaWQgRG9NZXNzYWdlKFNvY2tldCogY2xpZW50LCBjb25zdCBDVmlwU3lzdGVtU2VydmVyQVBJUmVxdWVzdCYgcmVxdWVzdCwgY29uc3Qgc3RkOjpzdHJpbmcmIHN0ck1zZyk7CgoJCXZpcnR1YWwgQ1ZpcFN5c3RlbVNlcnZlckFQSVJlc3VsdCBEb0xvZ2luKFNvY2tldCogY2xpZW50LCBjb25zdCBDVmlwU3lzdGVtU2VydmVyQVBJUmVxdWVzdCYgcmVxdWVzdCwgY29uc3Qgc3RkOjpzdHJpbmcmIHN0ck1zZyk7CgoJCXZpcnR1YWwgQ1ZpcFN5c3RlbVNlcnZlckFQSVJlc3VsdCBEb1JlZ2lzdGVyKFNvY2tldCogY2xpZW50LCBjb25zdCBDVmlwU3lzdGVtU2VydmVyQVBJUmVxdWVzdCYgcmVxdWVzdCwgY29uc3Qgc3RkOjpzdHJpbmcmIHN0ck1zZyk7CgoJCXZpcnR1YWwgQ1ZpcFN5c3RlbVNlcnZlckFQSVJlc3VsdCBEb0Rpc3BsYXlJbmZvKFNvY2tldCogY2xpZW50LCBjb25zdCBDVmlwU3lzdGVtU2VydmVyQVBJUmVxdWVzdCYgcmVxdWVzdCwgY29uc3Qgc3RkOjpzdHJpbmcmIHN0ck1zZyk7CgoJCXZpcnR1YWwgQ1ZpcFN5c3RlbVNlcnZlckFQSVJlc3VsdCBEb01vZGlmeUluZm8oU29ja2V0KiBjbGllbnQsIGNvbnN0IENWaXBTeXN0ZW1TZXJ2ZXJBUElSZXF1ZXN0JiByZXF1ZXN0LCBjb25zdCBzdGQ6OnN0cmluZyYgc3RyTXNnKTsKCX07CgoJQ1ZpcFN5c3RlbVNlcnZlcjo6Q1ZpcFN5c3RlbVNlcnZlcigpCgl7CgkJbV9iUnVuaW5nID0gZmFsc2U7CgkJLy9tX1NvY2sgPSBOVUxMOwoJCW1faVBvcnQgPSAyMDExOwoJCW1faUNvbm5lY3Rpb25zID0gMzsKCQltX2lBdXRvU2F2ZVRpbWVPdXQgPSAxMDAwOwoJCS8vbV9UaHJlYWRQb29sID0gTlVMTDsKCX0KCUNWaXBTeXN0ZW1TZXJ2ZXI6On5DVmlwU3lzdGVtU2VydmVyKCkKCXsKCQlTdG9wKCk7Cgl9CglpbnQgQ1ZpcFN5c3RlbVNlcnZlcjo6UnVubG9vcCgpCgl7CgkJaWYgKG1fYlJ1bmluZykKCQl7CgkJCXJldHVybiAtMTsKCQl9CgoJCW1fYlJ1bmluZyA9IHRydWU7CgkJU29ja2V0U2VydmVyKiBwU2VydmVyU29jayA9IG5ldyBTb2NrZXRTZXJ2ZXIobV9pUG9ydCwgbV9pQ29ubmVjdGlvbnMpOwoJCUNUaHJlYWRQb29sKiBwVGhyZWFkUG9vbCA9IG5ldyBDVGhyZWFkUG9vbCgpOwoJCXBUaHJlYWRQb29sLT5pbml0KCk7CgkJY2xvY2tfdCBjTGFzdFVwZGF0ZVRpbWUgPSBjbG9jaygpOwoJCUNVc2VyTWFuYWdlcjo6R2V0SW5zdGFuY2UoKS0+VXBkYXRlKCk7CgkJd2hpbGUgKG1fYlJ1bmluZykKCQl7CgkJCXRyeQoJCQl7CgkJCQljbG9ja190IGNOZXdUaW1lID0gY2xvY2soKTsKCQkJCWlmIChjTmV3VGltZSAtIGNMYXN0VXBkYXRlVGltZSA+IG1faUF1dG9TYXZlVGltZU91dCkKCQkJCXsKCQkJCQkvL+WmguaenOWcqOeoi+W6j+eahOepuumXsuaXtumXtO+8jOS4lOWSjOS4iuasoeabtOaWsOi2hei/h+i2heaXtumZkOWumiDlsLHkv53lrZgKCQkJCQlDVXNlck1hbmFnZXI6OkdldEluc3RhbmNlKCktPlNhdmUoKTsKCQkJCQkvL0NVc2VyTWFuYWdlcjo6R2V0SW5zdGFuY2UoKS0+VXBkYXRlKCk7CgkJCQl9CgkJCQlTb2NrZXQqIGNsaWVudCA9IHBTZXJ2ZXJTb2NrLT5BY2NlcHQoKTsKCQkJCWlmIChjbGllbnQgPT0gTlVMTCkKCQkJCXsKCQkJCQl0aHJvdyBzdGQ6OmV4Y2VwdGlvbigibm8gcmVxdWVzdCBwZW5kaW5nIik7CgkJCQl9CgkJCQlwVGhyZWFkUG9vbC0+c3VibWl0KFt0aGlzXShTb2NrZXQqIGNsaWVudCktPnZvaWQgewoJCQkJCXN0ZDo6c3RyaW5nIHN0ck1zZyA9IGNsaWVudC0+UmVjZWl2ZUxpbmUoKTsKCgkJCQkJQ1ZpcFN5c3RlbVNlcnZlckFQSVJlcXVlc3QgY2xSZXF1c3Q7CgkJCQkJaWYgKGNsUmVxdXN0LlBhcnNlKHN0ck1zZy5jX3N0cigpKSkKCQkJCQl7CgkJCQkJCURvTWVzc2FnZShjbGllbnQsIGNsUmVxdXN0LCBzdHJNc2cpOwoJCQkJCX0KCQkJCQllbHNlCgkJCQkJewoJCQkJCQljbGllbnQtPlNlbmRMaW5lKCJiYWQgY29ubmVjdCIpOwoJCQkJCX0KCQkJCQljbGllbnQtPkNsb3NlKCk7CgkJCQkJZGVsZXRlIGNsaWVudDsKCQkJCQl9LGNsaWVudCk7CgkJCX0KCQkJY2F0Y2ggKGNvbnN0IHN0ZDo6ZXhjZXB0aW9uJiBlKQoJCQl7CgkJCQkvL0xPRyBFUlIKCQkJfQoJCX0KCQlwVGhyZWFkUG9vbC0+c2h1dGRvd24oKTsKCQlkZWxldGUgcFRocmVhZFBvb2w7CgkJcFRocmVhZFBvb2wgPSBOVUxMOwoJCXBTZXJ2ZXJTb2NrLT5DbG9zZSgpOwoJCWRlbGV0ZSBwU2VydmVyU29jazsKCQlwU2VydmVyU29jayA9IE5VTEw7CgkJLy/nu5PmnZ/ml7bkuZ/kv53lrZgKCQlDVXNlck1hbmFnZXI6OkdldEluc3RhbmNlKCktPlNhdmUoKTsKCQlyZXR1cm4gMDsKCX0KCXZvaWQgQ1ZpcFN5c3RlbVNlcnZlcjo6U3RvcCgpCgl7CgkJaWYgKG1fYlJ1bmluZykKCQl7CgkJCW1fYlJ1bmluZyA9IGZhbHNlOwoKCQkJU29ja2V0Q2xpZW50IGNsaWVudCgiMTI3LjAuMC4xIiwgbV9pUG9ydCk7CgkJCWNsaWVudC5TZW5kTGluZSgiaGVsbG8iKTsKCQkJc3RkOjpzdHJpbmcgc3RyTWFnID0gY2xpZW50LlJlY2VpdmVMaW5lKCk7CgkJCXByaW50ZigiQ1ZpcFN5c3RlbVNlcnZlcjo6U3RvcCBtc2cgOiVzIFxuIiwgc3RyTWFnLmNfc3RyKCkpOwoJCQljbGllbnQuQ2xvc2UoKTsKCQl9Cgl9CgoJdm9pZCBDVmlwU3lzdGVtU2VydmVyOjpTZXRBdXRvU2F2ZVRpbWVPdXQoaW50IGlBdXRvU2F2ZVRpbWUpCgl7CgkJaWYgKGlBdXRvU2F2ZVRpbWUgPCAwKQoJCXsKCQkJbV9pQXV0b1NhdmVUaW1lT3V0ID0gMDsKCQl9CgkJZWxzZQoJCXsKCQkJbV9pQXV0b1NhdmVUaW1lT3V0ID0gaUF1dG9TYXZlVGltZTsKCQl9Cgl9CgoJaW50IENWaXBTeXN0ZW1TZXJ2ZXI6OkdldEF1dG9TYXZlVGltZU91dCgpCgl7CgkJcmV0dXJuIG1faUF1dG9TYXZlVGltZU91dDsKCX0KCgl2b2lkIENWaXBTeXN0ZW1TZXJ2ZXI6OkRvTWVzc2FnZShTb2NrZXQqIGNsaWVudCwgY29uc3QgQ1ZpcFN5c3RlbVNlcnZlckFQSVJlcXVlc3QmIHJlcXVlc3QsY29uc3Qgc3RkOjpzdHJpbmcmIHN0ck1zZykKCXsKCQlzdGQ6OnN0cmluZyBzdHJBcGlOYW1lID0gcmVxdWVzdC5HZXRBcGlOYW1lKCk7CgkJQ1ZpcFN5c3RlbVNlcnZlckFQSVJlc3VsdCByZXN1bHQoVklQU1lTX1JFU19DT0RFX0FQSU5PVEZPTkQsIkFQSSBOb3QgRm9uZCIpOwoJCWlmIChzdHJBcGlOYW1lID09ICJMb2dpbiIpCgkJewoJCQlyZXN1bHQgPSBEb0xvZ2luKGNsaWVudCwgcmVxdWVzdCwgc3RyTXNnKTsKCQl9CgkJZWxzZSBpZiAoc3RyQXBpTmFtZSA9PSAiUmVnaXN0ZXIiKQoJCXsKCQkJcmVzdWx0ID0gRG9SZWdpc3RlcihjbGllbnQsIHJlcXVlc3QsIHN0ck1zZyk7CgkJfQoJCWVsc2UgaWYgKHN0ckFwaU5hbWUgPT0gIkRpc3BsYXlJbmZvIikKCQl7CgkJCXJlc3VsdCA9IERvRGlzcGxheUluZm8oY2xpZW50LCByZXF1ZXN0LCBzdHJNc2cpOwoJCX0KCQllbHNlIGlmIChzdHJBcGlOYW1lID09ICJNb2RpZnlJbmZvIikKCQl7CgkJCXJlc3VsdCA9IERvTW9kaWZ5SW5mbyhjbGllbnQsIHJlcXVlc3QsIHN0ck1zZyk7CgkJfQoJCUpzb246OkZhc3RXcml0ZXIgaldyaXRlcjsKCQlzdGQ6OnN0cmluZyBzdHJSZXN1bHQgPSBqV3JpdGVyLndyaXRlKHJlc3VsdC5Ub0pzb24oKSk7CgkJY2xpZW50LT5TZW5kTGluZShzdHJSZXN1bHQpOwoJCWNsaWVudC0+UmVjZWl2ZUxpbmUoKTsKCX0KCglDVmlwU3lzdGVtU2VydmVyQVBJUmVzdWx0IENWaXBTeXN0ZW1TZXJ2ZXI6OkRvTG9naW4oU29ja2V0KiBjbGllbnQsIGNvbnN0IENWaXBTeXN0ZW1TZXJ2ZXJBUElSZXF1ZXN0JiByZXF1ZXN0LCBjb25zdCBzdGQ6OnN0cmluZyYgc3RyTXNnKQoJewoKCQlzdGQ6OnN0cmluZyBzdHJTZXNzaW9uSWQgPSByZXF1ZXN0LkdldFNlc3Npb25JZCgpOwoJCWlmIChzdHJTZXNzaW9uSWQgPT0gIiIpCgkJewoJCQlzdHJTZXNzaW9uSWQgPSBDSWRNYW5hZ2VyOjpHZXRJbnN0YW5jZSgpLT5HZXRJRCgic3NpZCIpOwoJCX0KCQlDVmlwU3lzdGVtU2VydmVyQVBJUmVzdWx0IHJlc3VsdChWSVBTWVNfUkVTX0NPREVfVU5LTk9XTiwiTG9naW4gZmFpbCIpOwoKCQljb25zdCBKc29uOjpWYWx1ZSYgcGFyYW1zID0gcmVxdWVzdC5HZXRSZXFQYXJhbSgpOwoJCXN0ZDo6c3RyaW5nIHN0ckFjY291bnQgPSBwYXJhbXNbQ1VzZXJNYW5hZ2VyOjpJTkZPS0VZX0FDQ09VTlRdLmFzU3RyaW5nKCk7CgkJc3RkOjpzdHJpbmcgc3RyUGFzc3dvcmQgPSBwYXJhbXNbQ1VzZXJNYW5hZ2VyOjpJTkZPS0VZX1BBU1NXT1JEXS5hc1N0cmluZygpOwoJCS8vVE9ETyDov5vooYznrb7lkI3pqozor4Egc2lnbgoJCUpzb246OlZhbHVlIGpvYmpVc2VySW5mbzsKCQlpZiAoQ1VzZXJNYW5hZ2VyOjpHZXRJbnN0YW5jZSgpLT5HZXRVc2VyKHN0ckFjY291bnQsIHN0clBhc3N3b3JkLCBqb2JqVXNlckluZm8pID09IDEpCgkJewoJCQl7CgkJCQkvL+iuvue9rlNlc3Npb24KCQkJCXN0ZDo6bG9ja19ndWFyZDxDVGhyZWFkTG9jaz4gX2xvY2tfdXNlX3Nlc3Npb25zKG1fU2Vzc2lvbnNMb2NrKTsKCQkJCUpzb246OlZhbHVlJiBqb2JqU2Vzc2lvbiA9IG1fbXBTZXNzaW9uc1tzdHJTZXNzaW9uSWRdOwoJCQkJam9ialNlc3Npb24gPSBqb2JqVXNlckluZm87CgkJCX0KCgkJCWpvYmpVc2VySW5mby5yZW1vdmVNZW1iZXIoQ1VzZXJNYW5hZ2VyOjpJTkZPS0VZX1BBU1NXT1JEKTsKCQkJcmVzdWx0LlNldFNlc3Npb25JZChzdHJTZXNzaW9uSWQuY19zdHIoKSk7CgkJCXJlc3VsdC5TZXRFcnJvck1zZygiIik7CgkJCXJlc3VsdC5TZXRDb2RlKDApOwoJCQlyZXN1bHQuU2V0UmVzRGF0YShqb2JqVXNlckluZm8pOwoJCX0KCgkJcmV0dXJuIHJlc3VsdDsKCX0KCglDVmlwU3lzdGVtU2VydmVyQVBJUmVzdWx0IENWaXBTeXN0ZW1TZXJ2ZXI6OkRvUmVnaXN0ZXIoU29ja2V0KiBjbGllbnQsIGNvbnN0IENWaXBTeXN0ZW1TZXJ2ZXJBUElSZXF1ZXN0JiByZXF1ZXN0LCBjb25zdCBzdGQ6OnN0cmluZyYgc3RyTXNnKQoJewoJCUNWaXBTeXN0ZW1TZXJ2ZXJBUElSZXN1bHQgcmVzdWx0KFZJUFNZU19SRVNfQ09ERV9VTktOT1dOLCAiUmVnaXN0ZXIgZmFpbCIpOwoJCWNvbnN0IEpzb246OlZhbHVlJiBwYXJhbXMgPSByZXF1ZXN0LkdldFJlcVBhcmFtKCk7CgkJc3RkOjpzdHJpbmcgc3RyQWNjb3VudCA9IHBhcmFtc1tDVXNlck1hbmFnZXI6OklORk9LRVlfQUNDT1VOVF0uYXNTdHJpbmcoKTsKCQlzdGQ6OnN0cmluZyBzdHJQYXNzd29yZCA9IHBhcmFtc1tDVXNlck1hbmFnZXI6OklORk9LRVlfUEFTU1dPUkRdLmFzU3RyaW5nKCk7CgkJLy9UT0RPIOi/m+ihjOetvuWQjemqjOivgSBzaWduCgkJc3RkOjp2ZWN0b3I8SnNvbjo6VmFsdWU+IHZlY1VzZXJzOwoJCUpzb246OlZhbHVlIGpvYmpGaW5kUGFyYW07CgkJam9iakZpbmRQYXJhbVtDVXNlck1hbmFnZXI6OklORk9LRVlfQUNDT1VOVF0gPSBzdHJBY2NvdW50OwoJCWlmIChzdHJBY2NvdW50LmVtcHR5KCkgfHwgc3RyUGFzc3dvcmQuZW1wdHkoKSkKCQl7CgkJCXJlc3VsdC5TZXRFcnJvck1zZygiVGhlIGFjY291bnQgZW1wdHkuIik7CgkJCXJldHVybiByZXN1bHQ7CgkJfQoJCWlmIChDVXNlck1hbmFnZXI6OkdldEluc3RhbmNlKCktPkdldFVzZXJzKGpvYmpGaW5kUGFyYW0sMSwgdmVjVXNlcnMpICE9IDApCgkJewoJCQkvL+aXp+i0puWPt+W3sue7j+WtmOWcqAoJCQlyZXN1bHQuU2V0RXJyb3JNc2coIlRoZSBhY2NvdW50IGFscmVhZHkgZXhpc3RzLiIpOwoJCQlyZXR1cm4gcmVzdWx0OwoJCX0KCgkJSnNvbjo6VmFsdWUgam9iak5ld1VzZXJJbmZvOwoJCWpvYmpOZXdVc2VySW5mb1tDVXNlck1hbmFnZXI6OklORk9LRVlfQUNDT1VOVF0gPSBzdHJBY2NvdW50OwoJCXN0ZDo6c3RyaW5nIHN0clVzZXJJRDsKCQlDVXNlck1hbmFnZXI6OkdldEluc3RhbmNlKCktPkFkZFVzZXIoc3RyVXNlcklELGpvYmpOZXdVc2VySW5mbyk7CgkJcmVzdWx0LlNldEVycm9yTXNnKE5VTEwpOwoJCXJlc3VsdC5TZXRDb2RlKFZJUFNZU19SRVNfQ09ERV9TVUMpOwoJCXJlc3VsdC5TZXRSZXNEYXRhKHN0clVzZXJJRCk7CgkJcmV0dXJuIHJlc3VsdDsKCX0KCglDVmlwU3lzdGVtU2VydmVyQVBJUmVzdWx0IENWaXBTeXN0ZW1TZXJ2ZXI6OkRvRGlzcGxheUluZm8oU29ja2V0KiBjbGllbnQsIGNvbnN0IENWaXBTeXN0ZW1TZXJ2ZXJBUElSZXF1ZXN0JiByZXF1ZXN0LCBjb25zdCBzdGQ6OnN0cmluZyYgc3RyTXNnKQoJewoJCUNWaXBTeXN0ZW1TZXJ2ZXJBUElSZXN1bHQgcmVzdWx0KFZJUFNZU19SRVNfQ09ERV9VTktOT1dOLCAiRGlzcGxheUluZm8gZmFpbCIpOwoJCXN0ZDo6c3RyaW5nIHN0clNlc3Npb25JZCA9IHJlcXVlc3QuR2V0U2Vzc2lvbklkKCk7CgkJaWYgKHN0clNlc3Npb25JZCA9PSAiIikKCQl7CgkJCXJlc3VsdC5TZXRFcnJvck1zZygiRGlzcGxheUluZm8gZmFpbDogd2hhdCA6IG5vdCBsb2dpbiIpOwoJCQlyZXN1bHQuU2V0Q29kZShWSVBTWVNfUkVTX0NPREVfTk9UTE9HSU4pOwoJCQlyZXR1cm4gcmVzdWx0OwoJCX0KCQlyZXN1bHQuU2V0U2Vzc2lvbklkKHN0clNlc3Npb25JZC5jX3N0cigpKTsKCQlzdGQ6OnN0cmluZyBzdHJDdXJyZW50TG9naW5Vc2VySWQ7CgkJSnNvbjo6VmFsdWUgam9iakN1cnJlbnRVc2VyOwoJCXsKCQkJc3RkOjpsb2NrX2d1YXJkPENUaHJlYWRMb2NrPiBfbG9ja191c2Vfc2Vzc2lvbnMobV9TZXNzaW9uc0xvY2spOwoJCQlhdXRvIHJlZlNlc3Npb24gPSBtX21wU2Vzc2lvbnMuZmluZChzdHJTZXNzaW9uSWQpOwoJCQlpZiAocmVmU2Vzc2lvbiA9PSBtX21wU2Vzc2lvbnMuZW5kKCkpCgkJCXsKCQkJCXJlc3VsdC5TZXRFcnJvck1zZygiRGlzcGxheUluZm8gZmFpbDogd2hhdCA6IG5vdCBsb2dpbiIpOwoJCQkJcmVzdWx0LlNldENvZGUoVklQU1lTX1JFU19DT0RFX05PVExPR0lOKTsKCQkJCXJldHVybiByZXN1bHQ7CgkJCX0KCQkJam9iakN1cnJlbnRVc2VyID0gcmVmU2Vzc2lvbi0+c2Vjb25kOwoJCQlzdHJDdXJyZW50TG9naW5Vc2VySWQgPSBqb2JqQ3VycmVudFVzZXJbQ1VzZXJNYW5hZ2VyOjpJTkZPS0VZX0lEXS5hc1N0cmluZygpOwoJCX0KCQlKc29uOjpWYWx1ZSBqb2JqVXNlcjsKCQlDVXNlck1hbmFnZXI6OkdldEluc3RhbmNlKCktPkdldFVzZXIoc3RyQ3VycmVudExvZ2luVXNlcklkLCBqb2JqVXNlcik7CgkJaWYgKGpvYmpDdXJyZW50VXNlcltDVXNlck1hbmFnZXI6OklORk9LRVlfUEFTU1dPUkRdICE9IGpvYmpVc2VyW0NVc2VyTWFuYWdlcjo6SU5GT0tFWV9QQVNTV09SRF0pCgkJewoJCQlyZXN1bHQuU2V0Q29kZShWSVBTWVNfUkVTX0NPREVfQUNDT1VOVENIRUNLRVJSKTsKCQkJcmVzdWx0LlNldEVycm9yTXNnKCJUaGUgcGFzc3dvcmQgaGFzIGJlZW4gY2hhbmdlZC4iKTsvL+WvhueggeW3sue7j+abtOaUuQoJCQlyZXR1cm4gcmVzdWx0OwoJCX0KCQlyZXN1bHQuU2V0Q29kZShWSVBTWVNfUkVTX0NPREVfU1VDKTsKCQlyZXN1bHQuU2V0RXJyb3JNc2coTlVMTCk7CgkJcmVzdWx0LlNldFJlc0RhdGEoam9ialVzZXIpOwoJCXJldHVybiByZXN1bHQ7Cgl9CgoJQ1ZpcFN5c3RlbVNlcnZlckFQSVJlc3VsdCBDVmlwU3lzdGVtU2VydmVyOjpEb01vZGlmeUluZm8oU29ja2V0KiBjbGllbnQsIGNvbnN0IENWaXBTeXN0ZW1TZXJ2ZXJBUElSZXF1ZXN0JiByZXF1ZXN0LCBjb25zdCBzdGQ6OnN0cmluZyYgc3RyTXNnKQoJewoJCUNWaXBTeXN0ZW1TZXJ2ZXJBUElSZXN1bHQgcmVzdWx0KFZJUFNZU19SRVNfQ09ERV9VTktOT1dOLCAiRGlzcGxheUluZm8gZmFpbCIpOwoJCXN0ZDo6c3RyaW5nIHN0clNlc3Npb25JZCA9IHJlcXVlc3QuR2V0U2Vzc2lvbklkKCk7CgkJaWYgKHN0clNlc3Npb25JZCA9PSAiIikKCQl7CgkJCXJlc3VsdC5TZXRFcnJvck1zZygiRGlzcGxheUluZm8gZmFpbDogd2hhdCA6IG5vdCBsb2dpbiIpOwoJCQlyZXN1bHQuU2V0Q29kZShWSVBTWVNfUkVTX0NPREVfTk9UTE9HSU4pOwoJCQlyZXR1cm4gcmVzdWx0OwoJCX0KCQlyZXN1bHQuU2V0U2Vzc2lvbklkKHN0clNlc3Npb25JZC5jX3N0cigpKTsKCQlzdGQ6OnN0cmluZyBzdHJDdXJyZW50TG9naW5Vc2VySWQ7CgkJSnNvbjo6VmFsdWUgam9iakN1cnJlbnRVc2VyOwoJCXsKCQkJc3RkOjpsb2NrX2d1YXJkPENUaHJlYWRMb2NrPiBfbG9ja191c2Vfc2Vzc2lvbnMobV9TZXNzaW9uc0xvY2spOwoJCQlhdXRvIHJlZlNlc3Npb24gPSBtX21wU2Vzc2lvbnMuZmluZChzdHJTZXNzaW9uSWQpOwoJCQlpZiAocmVmU2Vzc2lvbiA9PSBtX21wU2Vzc2lvbnMuZW5kKCkpCgkJCXsKCQkJCXJlc3VsdC5TZXRFcnJvck1zZygiRGlzcGxheUluZm8gZmFpbDogd2hhdCA6IG5vdCBsb2dpbiIpOwoJCQkJcmVzdWx0LlNldENvZGUoVklQU1lTX1JFU19DT0RFX05PVExPR0lOKTsKCQkJCXJldHVybiByZXN1bHQ7CgkJCX0KCQkJam9iakN1cnJlbnRVc2VyID0gcmVmU2Vzc2lvbi0+c2Vjb25kOwoJCQlzdHJDdXJyZW50TG9naW5Vc2VySWQgPSBqb2JqQ3VycmVudFVzZXJbQ1VzZXJNYW5hZ2VyOjpJTkZPS0VZX0lEXS5hc1N0cmluZygpOwoJCX0KCQlKc29uOjpWYWx1ZSBqb2JqVXNlcjsKCQlDVXNlck1hbmFnZXI6OkdldEluc3RhbmNlKCktPkdldFVzZXIoc3RyQ3VycmVudExvZ2luVXNlcklkLCBqb2JqVXNlcik7CgkJaWYgKGpvYmpDdXJyZW50VXNlcltDVXNlck1hbmFnZXI6OklORk9LRVlfUEFTU1dPUkRdICE9IGpvYmpVc2VyW0NVc2VyTWFuYWdlcjo6SU5GT0tFWV9QQVNTV09SRF0pCgkJewoJCQlyZXN1bHQuU2V0Q29kZShWSVBTWVNfUkVTX0NPREVfQUNDT1VOVENIRUNLRVJSKTsKCQkJcmVzdWx0LlNldEVycm9yTXNnKCJUaGUgcGFzc3dvcmQgaGFzIGJlZW4gY2hhbmdlZC4iKTsvL+WvhueggeW3sue7j+abtOaUuQoJCQlyZXR1cm4gcmVzdWx0OwoJCX0KCgkJSnNvbjo6VmFsdWUgam9iak5ld1VzZXJJbmZvOwoJCWNvbnN0IEpzb246OlZhbHVlJiBqb2JqUmVxUGFyYW0gPSByZXF1ZXN0LkdldFJlcVBhcmFtKCk7CgkJLy9zdGQ6OnZlY3RvcjxzdGQ6OnN0cmluZz4gdmVjTW9kaWZ5RmlsdGVyID0geyBDVXNlck1hbmFnZXI6OklORk9LRVlfU0VYLENVc2VyTWFuYWdlcjo6SU5GT0tFWV9OQU1FIH07CgkJZm9yIChhdXRvIHJlZlJlcU1lbWJlciA9IGpvYmpSZXFQYXJhbS5iZWdpbigpOyByZWZSZXFNZW1iZXIgIT0gam9ialJlcVBhcmFtLmVuZCgpOyByZWZSZXFNZW1iZXIrKykKCQl7CgkJCXN0ZDo6c3RyaW5nIHN0ck1lbWJlck5hbWUgPSByZWZSZXFNZW1iZXIubmFtZSgpOwoJCQlpZiAoc3RyTWVtYmVyTmFtZSA9PSBDVXNlck1hbmFnZXI6OklORk9LRVlfU0VYKQoJCQl7CgkJCQlpZiAocmVmUmVxTWVtYmVyLT5hc1N0cmluZygpID09ICJtYW4iKQoJCQkJewoJCQkJCWpvYmpOZXdVc2VySW5mb1tzdHJNZW1iZXJOYW1lXSA9ICJtYW4iOwoJCQkJfQoJCQkJZWxzZQoJCQkJewoJCQkJCWpvYmpOZXdVc2VySW5mb1tzdHJNZW1iZXJOYW1lXSA9ICJ3b21hbiI7CgkJCQl9CgkJCX0KCQkJZWxzZSBpZihzdHJNZW1iZXJOYW1lID09IENVc2VyTWFuYWdlcjo6SU5GT0tFWV9OQU1FKQoJCQl7CgkJCQlzdGQ6OnN0cmluZyBzdHJOYW1lID0gcmVmUmVxTWVtYmVyLT5hc1N0cmluZygpOwoJCQkJaWYgKHN0ck5hbWUubGVuZ3RoKCkgPiBWSVBTWVNfTUFYX05BTUVTSVpFKS8v6LaF5Ye65ZCN56ew5pyA5aSn6ZW/5bqm5Y+q5L+d55WZ5YmN6Z2i5LiA5q61CgkJCQl7CgkJCQkJc3RyTmFtZSA9IHN0ck5hbWUuc3Vic3RyKDAsIFZJUFNZU19NQVhfTkFNRVNJWkUpOwoJCQkJfQoJCQkJam9iak5ld1VzZXJJbmZvW3N0ck1lbWJlck5hbWVdID0gc3RyTmFtZTsKCQkJfQoJCX0KCQlDVXNlck1hbmFnZXI6OkdldEluc3RhbmNlKCktPk1vZGlmeVVzZXIoc3RyQ3VycmVudExvZ2luVXNlcklkLCBqb2JqTmV3VXNlckluZm8pOwoJCXJlc3VsdC5TZXRDb2RlKFZJUFNZU19SRVNfQ09ERV9TVUMpOwoJCXJlc3VsdC5TZXRFcnJvck1zZyhOVUxMKTsKCQlyZXN1bHQuU2V0UmVzRGF0YSgiT2siKTsKCQlyZXR1cm4gcmVzdWx0OwoJfQoKCWNsYXNzIENWaXBTeXN0ZW1DbGllbnQKCXsKCXB1YmxpYzoKCQlDVmlwU3lzdGVtQ2xpZW50KGNvbnN0IGNoYXIqIGhvc3QgPSAiMTI3LjAuMC4xIiwgaW50IHBvcnQgPSAyMDExKTsKCQl+Q1ZpcFN5c3RlbUNsaWVudCgpOwoJcHVibGljOgoJCUNWaXBTeXN0ZW1TZXJ2ZXJBUElSZXN1bHQgUmVxdWVzdChzdGQ6OnN0cmluZyBzdHJBcGlOYW1lLCBjb25zdCBKc29uOjpWYWx1ZSYgcGFyYW0pOwoJcHJpdmF0ZToKCQlpbnQgbV9pUG9ydDsKCQlzdGQ6OnN0cmluZyBtX3N0ckhvc3Q7CgkJc3RkOjpzdHJpbmcgbV9zdHJTZXNzaW9uOwoJfTsKCglDVmlwU3lzdGVtQ2xpZW50OjpDVmlwU3lzdGVtQ2xpZW50KGNvbnN0IGNoYXIqIGhvc3QsIGludCBwb3J0KQoJewoJCW1faVBvcnQgPSBwb3J0OwoJCW1fc3RySG9zdCA9IGhvc3Q7Cgl9CgoJQ1ZpcFN5c3RlbUNsaWVudDo6fkNWaXBTeXN0ZW1DbGllbnQoKQoJewoJfQoKCUNWaXBTeXN0ZW1TZXJ2ZXJBUElSZXN1bHQgQ1ZpcFN5c3RlbUNsaWVudDo6UmVxdWVzdChzdGQ6OnN0cmluZyBzdHJBcGlOYW1lLCBjb25zdCBKc29uOjpWYWx1ZSYgcGFyYW0pCgl7CgkJU29ja2V0Q2xpZW50IGNsaWVudChtX3N0ckhvc3QuY19zdHIoKSwgbV9pUG9ydCk7CgkJSnNvbjo6VmFsdWUgam9ialJlcVBhcmFtOwoJCWpvYmpSZXFQYXJhbVtWSVBTWVNfUkVRX0FQSUtFWV0gPSBzdHJBcGlOYW1lOwoJCWpvYmpSZXFQYXJhbVtWSVBTWVNfUkVRX1BBUkFNU0tFWV0gPSBwYXJhbTsKCQlpZiAoIW1fc3RyU2Vzc2lvbi5lbXB0eSgpKQoJCXsKCQkJam9ialJlcVBhcmFtW1ZJUFNZU19SRVFfU0VTU0lPTktFWV0gPSBtX3N0clNlc3Npb247CgkJfQoJCUpzb246OkZhc3RXcml0ZXIgd3JpdGVyOwoJCXN0ZDo6c3RyaW5nIHN0clJlcVBhcmFtZXRlciA9ICB3cml0ZXIud3JpdGUoam9ialJlcVBhcmFtKTsKCQljbGllbnQuU2VuZExpbmUoc3RyUmVxUGFyYW1ldGVyKTsKCQlzdGQ6OnN0cmluZyBzdHJSZXMgPSBjbGllbnQuUmVjZWl2ZUxpbmUoKTsKCQlDVmlwU3lzdGVtU2VydmVyQVBJUmVzdWx0IHJlc3VsdDsKCQlyZXN1bHQuUGFyc2Uoc3RyUmVzLmNfc3RyKCkpOwoJCW1fc3RyU2Vzc2lvbiA9IHJlc3VsdC5HZXRTZXNzaW9uSWQoKTsKCQljbGllbnQuU2VuZExpbmUoIjpjbG9zZSIpOwoJCWNsaWVudC5DbG9zZSgpOwoJCXJldHVybiByZXN1bHQ7Cgl9Cn0KCmludCBtYWluKCkKewoJVmlwU3lzdGVtOjpDVmlwU3lzdGVtU2VydmVyIHNlcnZlcjsKCXN0ZDo6dGhyZWFkIHNlcnZlclQoWyZzZXJ2ZXJdKCktPnZvaWQgewoJCXNlcnZlci5SdW5sb29wKCk7CgkJfSk7CglWaXBTeXN0ZW06OkNWaXBTeXN0ZW1DbGllbnQgY2xpZW50OwoJSnNvbjo6VmFsdWUgam9iakxvZ2luUGFyYW07Cglqb2JqTG9naW5QYXJhbVtWaXBTeXN0ZW06OkNVc2VyTWFuYWdlcjo6SU5GT0tFWV9BQ0NPVU5UXSA9ICJBSS0yMDIyMTAyNDE3MTIzOS0wMDAwMDAwYSI7Cglqb2JqTG9naW5QYXJhbVtWaXBTeXN0ZW06OkNVc2VyTWFuYWdlcjo6SU5GT0tFWV9QQVNTV09SRF0gPSAiMTIzNDU2IjsKCWpvYmpMb2dpblBhcmFtW1ZpcFN5c3RlbTo6Q1VzZXJNYW5hZ2VyOjpJTkZPS0VZX05BTUVdID0gIlpodUppbnd1IjsKCWpvYmpMb2dpblBhcmFtW1ZpcFN5c3RlbTo6Q1VzZXJNYW5hZ2VyOjpJTkZPS0VZX1NFWF0gPSAid29tYW4iOwoJSnNvbjo6VmFsdWUgam9ialJlcSA9IGNsaWVudC5SZXF1ZXN0KCJMb2dpbiIsIGpvYmpMb2dpblBhcmFtKS5Ub0pzb24oKTsKCUpzb246OkZhc3RXcml0ZXIgd3JpdGVyOwoJc3RkOjpzdHJpbmcgc3RyUmVxID0gd3JpdGVyLndyaXRlKGpvYmpSZXEpOwoJcHJpbnRmKCJyZXE6JXMgXG4iLCBzdHJSZXEuY19zdHIoKSk7CgoJam9ialJlcSA9IGNsaWVudC5SZXF1ZXN0KCJNb2RpZnlJbmZvIiwgam9iakxvZ2luUGFyYW0pLlRvSnNvbigpOwoJc3RyUmVxID0gd3JpdGVyLndyaXRlKGpvYmpSZXEpOwoJcHJpbnRmKCJyZXE6JXMgXG4iLCBzdHJSZXEuY19zdHIoKSk7CgoJam9ialJlcSA9IGNsaWVudC5SZXF1ZXN0KCJEaXNwbGF5SW5mbyIsIGpvYmpMb2dpblBhcmFtKS5Ub0pzb24oKTsKCXN0clJlcSA9IHdyaXRlci53cml0ZShqb2JqUmVxKTsKCXByaW50ZigicmVxOiVzIFxuIiwgc3RyUmVxLmNfc3RyKCkpOwoJc2VydmVyLlN0b3AoKTsKCXNlcnZlclQuam9pbigpOwoJcmV0dXJuIDA7Cn0=
